#!/usr/bin/env python3
"""
ÐœÐ°ÑÑ‚ÐµÑ€-ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿ÐµÐ½Ñ‚ÐµÑÑ‚Ð° Zooplus
Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ PENTEST_PLAN.md
"""

import subprocess
import sys
from datetime import datetime
import json
import os

def run_test(test_name, script_path):
    """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚"""
    print("\n" + "=" * 70)
    print(f"Running: {test_name}")
    print("=" * 70)
    
    try:
        result = subprocess.run(
            [sys.executable, script_path],
            capture_output=True,
            text=True,
            timeout=300  # 5 minutes timeout
        )
        
        print(result.stdout)
        if result.stderr:
            print("STDERR:", result.stderr)
        
        return {
            "test": test_name,
            "status": "SUCCESS" if result.returncode == 0 else "FAILED",
            "returncode": result.returncode
        }
        
    except subprocess.TimeoutExpired:
        print(f"[!] Test {test_name} timed out!")
        return {
            "test": test_name,
            "status": "TIMEOUT"
        }
    except Exception as e:
        print(f"[!] Error running {test_name}: {e}")
        return {
            "test": test_name,
            "status": "ERROR",
            "error": str(e)
        }


def main():
    print("=" * 70)
    print("ZOOPLUS COMPREHENSIVE PENETRATION TEST")
    print(f"Start Time: {datetime.now()}")
    print("=" * 70)
    
    # Ensure reports directory exists
    os.makedirs("reports", exist_ok=True)
    
    # Test suite ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ PENTEST_PLAN.md
    tests = [
        {
            "name": "1. Authentication & Rate Limiting",
            "script": "scripts/test_rate_limiting.py",
            "priority": "HIGH"
        },
        {
            "name": "2. Authorization / IDOR Tests",
            "script": "scripts/test_idor_comprehensive.py",
            "priority": "CRITICAL"
        },
        {
            "name": "3. XSS / HTML Injection",
            "script": "scripts/test_xss_full.py",
            "priority": "HIGH"
        },
        {
            "name": "4. CSRF Protection",
            "script": "scripts/test_csrf.py",
            "priority": "HIGH"
        },
        {
            "name": "5. Security Headers",
            "script": "scripts/test_security_headers.py",
            "priority": "MEDIUM"
        },
    ]
    
    results = []
    
    # Run each test
    for test in tests:
        print(f"\n[{test['priority']}] Starting: {test['name']}")
        result = run_test(test['name'], test['script'])
        results.append(result)
    
    # Summary
    print("\n" + "=" * 70)
    print("PENTEST SUMMARY")
    print("=" * 70)
    
    print(f"\nTests completed: {len(results)}")
    success = len([r for r in results if r['status'] == 'SUCCESS'])
    failed = len([r for r in results if r['status'] == 'FAILED'])
    errors = len([r for r in results if r['status'] == 'ERROR'])
    
    print(f"  âœ“ Success: {success}")
    print(f"  âœ— Failed: {failed}")
    print(f"  ! Errors: {errors}")
    
    print("\nTest Results:")
    for result in results:
        status_symbol = "âœ“" if result['status'] == 'SUCCESS' else "âœ—"
        print(f"  {status_symbol} {result['test']}: {result['status']}")
    
    # Check for findings
    print("\n" + "=" * 70)
    print("VULNERABILITIES FOUND")
    print("=" * 70)
    
    finding_files = [
        "reports/xss_findings.json",
        "reports/idor_findings.json",
        "reports/csrf_findings.json",
        "reports/security_headers_findings.json"
    ]
    
    total_findings = 0
    critical_count = 0
    high_count = 0
    medium_count = 0
    low_count = 0
    
    for finding_file in finding_files:
        if os.path.exists(finding_file):
            try:
                with open(finding_file, 'r') as f:
                    findings = json.load(f)
                    if findings:
                        total_findings += len(findings)
                        
                        for finding in findings:
                            severity = finding.get('severity', 'UNKNOWN')
                            if severity == 'CRITICAL':
                                critical_count += 1
                            elif severity == 'HIGH':
                                high_count += 1
                            elif severity == 'MEDIUM':
                                medium_count += 1
                            elif severity == 'LOW':
                                low_count += 1
                        
                        print(f"\n{finding_file}:")
                        for finding in findings:
                            print(f"  [{finding.get('severity', 'N/A')}] {finding.get('type', 'Unknown')}")
                            if 'endpoint' in finding:
                                print(f"      Endpoint: {finding['endpoint']}")
                            if 'description' in finding:
                                print(f"      {finding['description']}")
            except Exception as e:
                print(f"[!] Error reading {finding_file}: {e}")
    
    print("\n" + "=" * 70)
    print(f"TOTAL VULNERABILITIES: {total_findings}")
    print("=" * 70)
    print(f"  ðŸ”´ Critical: {critical_count}")
    print(f"  ðŸŸ  High: {high_count}")
    print(f"  ðŸŸ¡ Medium: {medium_count}")
    print(f"  ðŸŸ¢ Low: {low_count}")
    
    # Generate summary report
    summary = {
        "test_date": datetime.now().isoformat(),
        "target": "www.zooplus.de",
        "tests_run": len(results),
        "total_vulnerabilities": total_findings,
        "severity_breakdown": {
            "critical": critical_count,
            "high": high_count,
            "medium": medium_count,
            "low": low_count
        },
        "test_results": results
    }
    
    with open("reports/pentest_summary.json", "w") as f:
        json.dump(summary, f, indent=2)
    
    print(f"\n[+] Summary saved to: reports/pentest_summary.json")
    print(f"\nEnd Time: {datetime.now()}")
    
    # Next steps
    print("\n" + "=" * 70)
    print("NEXT STEPS")
    print("=" * 70)
    
    if total_findings > 0:
        print("\n[!] Vulnerabilities found! Next steps:")
        print("  1. Review all findings in reports/ directory")
        print("  2. Verify each vulnerability manually")
        print("  3. Create detailed PoC for each confirmed vulnerability")
        print("  4. Calculate accurate CVSS scores")
        print("  5. Prepare HackerOne reports")
    else:
        print("\n[+] No vulnerabilities found in automated tests")
        print("  1. Review manual testing areas from TEST_CHECKLIST.md")
        print("  2. Test areas that require authentication")
        print("  3. Perform business logic testing")
        print("  4. Check for edge cases")
    
    print("\n[*] See PENTEST_PLAN.md for complete testing methodology")


if __name__ == "__main__":
    main()

