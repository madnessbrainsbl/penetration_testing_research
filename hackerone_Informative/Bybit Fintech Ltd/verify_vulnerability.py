import re

filepath = '/media/sf_vremen/hackerone/Bybit Fintech Ltd/recon_data/login-entry.js'

with open(filepath, 'r', errors='ignore') as f:
    content = f.read()

# Find the complianceSDKApi2Host usage and extract MUCH MORE context
target = 'complianceSDKApi2Host'
idx = content.find(target)

if idx != -1:
    # Extract 2000 chars before and after
    start = max(0, idx - 2000)
    end = min(len(content), idx + 2000)
    
    print("="*80)
    print("FULL CONTEXT AROUND complianceSDKApi2Host (4000 chars)")
    print("="*80)
    print(content[start:end])
    print("\n" + "="*80)
    
    # Now trace where variable 'he' is used
    # The pattern is: const he=...localStorage.getItem("complianceSDKApi2Host")||T
    # Find what happens with 'he' after this assignment
    
    # Extract the variable name assigned to complianceSDKApi2Host
    pattern = r'(const|let|var)\s+(\w+)\s*=.*complianceSDKApi2Host'
    match = re.search(pattern, content[max(0, idx-100):idx+200])
    if match:
        var_name = match.group(2)
        print(f"\n\nVariable name: {var_name}")
        print(f"Searching for usage of '{var_name}'...\n")
        
        # Find all usages of this variable
        usages = []
        for m in re.finditer(rf'\b{var_name}\b', content):
            usage_start = max(0, m.start() - 200)
            usage_end = min(len(content), m.end() + 200)
            usages.append((m.start(), content[usage_start:usage_end]))
        
        print(f"Found {len(usages)} usages of '{var_name}':")
        for i, (pos, ctx) in enumerate(usages[:10]):  # Show first 10
            print(f"\n--- Usage {i+1} at position {pos} ---")
            print(ctx)
            print("-"*80)

print("\n\n" + "="*80)
print("CHECKING IF THERE'S VALIDATION OR WHITELIST")
print("="*80)

# Search for any validation patterns
validation_patterns = [
    r'whitelist|allowlist|allowed.*host|valid.*host|check.*host',
    r'includes\(["\']bybit\.com["\']',
    r'endsWith\(["\']bybit',
    r'test\(.*host\)',
    r'match\(.*host\)'
]

for pattern in validation_patterns:
    matches = re.finditer(pattern, content, re.IGNORECASE)
    for m in matches:
        start = max(0, m.start() - 150)
        end = min(len(content), m.end() + 150)
        print(f"\nValidation pattern found: {m.group()}")
        print(content[start:end])
        print("-"*80)
